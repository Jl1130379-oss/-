<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±Ÿå®¶å§Šå¦¹ï¼šé›²ç«¯æ™ºæ…§å­¸ç¿’ç³»çµ±</title>
    <style>
        :root { --sci: #00E5FF; --art: #FF4081; --dark: #0F172A; --gold: #FFD700; }
        * { box-sizing: border-box; font-family: "PingFang TC", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
        header { padding: 10px 20px; background: #000; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; }
        .stat-item { background: #1E293B; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .energy-bar { width: 50px; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .energy-fill { height: 100%; background: #4CAF50; transition: 0.3s; }

        /* æ ¸å¿ƒå±•ç¤ºå€ */
        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
        .character-zone { position: relative; width: 200px; height: 320px; margin-bottom: 10px; }
        .teacher-img { width: 100%; height: 100%; object-fit: contain; position: absolute; transition: 0.5s; }
        
        /* è£é£¾å±¤ï¼šé«®é£¾èˆ‡æœè£ç‰¹æ•ˆ */
        #layer-hair { z-index: 10; width: 100%; height: 40%; position: absolute; top: 0; display: flex; justify-content: center; font-size: 2rem; }
        #layer-dress { z-index: 5; width: 100%; height: 100%; position: absolute; mix-blend-mode: soft-light; pointer-events: none; }

        .bubble { background: #1E293B; border: 1px solid #334155; padding: 12px; border-radius: 18px; width: 90%; max-width: 400px; text-align: center; margin-bottom: 15px; font-size: 0.9rem; position: relative; border-left: 5px solid var(--sci); }
        .quiz-card { background: white; color: #1E293B; padding: 20px; border-radius: 25px; width: 100%; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; }
        .btn { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #F1F5F9; border-radius: 12px; background: white; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn:active { transform: scale(0.98); }

        /* å°èˆªæ¬„ */
        nav { background: #000; display: flex; border-top: 1px solid #333; }
        .nav-btn { flex: 1; padding: 15px; background: none; border: none; color: #64748B; cursor: pointer; font-size: 0.85rem; }
        .nav-btn.active { color: white; border-bottom: 3px solid var(--sci); }

        /* å¿«é–ƒç‰¹æ•ˆ */
        #flash-alert { position: absolute; top: 10px; right: 10px; background: var(--gold); color: black; padding: 5px 10px; border-radius: 5px; font-weight: bold; animation: pulse 1s infinite; display: none; z-index: 100; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div class="stat-item">ğŸ‘¤ <span id="u-name">å­¸ç”Ÿ</span></div>
    <div class="stat-item">âš¡ <div class="energy-bar"><div id="e-fill" class="energy-fill"></div></div></div>
    <div class="stat-item">ğŸª™ <span id="u-coins">0</span></div>
</header>

<main>
    <div id="flash-alert">âš¡ å¿«é–ƒèª²ç¨‹ï¼šé™å®šé«®é£¾çå‹µï¼</div>
    <div id="talk" class="bubble">æ­£åœ¨åŒæ­¥æ±Ÿè€å¸«çš„ç§èŠç³»çµ±...</div>

    <div class="character-zone">
        <div id="layer-hair"></div> <img id="pic-sci" class="teacher-img" src="IMG_3812.jpeg">
        <img id="pic-art" class="teacher-img" src="IMG_4392.jpg" style="display:none;">
        <div id="layer-dress"></div> </div>

    <div class="quiz-card">
        <h3 id="q-text" style="margin-top:0;">æº–å‚™å¥½é–‹å§‹æŒ‘æˆ°äº†å—ï¼Ÿ</h3>
        <div id="options">
            <button class="btn" onclick="startLesson()">é–‹å§‹èª²ç¨‹ (è€—è²» 20 âš¡)</button>
        </div>
    </div>
</main>

<nav>
    <button id="nav-sci" class="nav-btn active" onclick="switchTeacher('sci')">æ±Ÿéˆ´ (ç†ç§‘)</button>
    <button id="nav-art" class="nav-btn" onclick="switchTeacher('art')">æ±Ÿä¾ (æ–‡ç§‘)</button>
    <button class="nav-btn" onclick="openShop()">ğŸ›ï¸ å•†åŸ/æ›è£</button>
</nav>

<script>
    // --- éŠæˆ²æ•¸æ“šæ ¸å¿ƒ ---
    let user = {
        name: "å°æ±Ÿ", coins: 0, energy: 100,
        sci_lv: 0, art_lv: 0, 
        inventory: [], // æ“æœ‰çš„é«®é£¾é«®å‹
        wearingHair: "",
        lastSync: Date.now()
    };

    const dressLibrary = {
        sci: ["å°ˆæ¥­é‰›ç­†è£™", "é†«ç”¨ç™¾è¤¶è£™", "çŸ¥æ€§é•·è£™", "æ¥µå…‰å¯¦é©—è£™"],
        art: ["å¢¨é¦™å‚˜è£™", "å¤å…¸æ——è¢è£™", "æ–‡è—ç™¾è‘‰è£™", "è½æ«»é•·è£™"]
    };

    const shopItems = [
        { id: "h1", name: "è´è¶çµé«®é£¾", price: 500, icon: "ğŸ€" },
        { id: "h2", name: "æ™ºæ…§é«®ç®", price: 1000, icon: "ğŸ‘‘" },
        { id: "h3", name: "æ–‡è—é«®å¤¾", price: 1500, icon: "ğŸŒ¸" }
    ];

    let currentT = 'sci';
    let isLessonActive = false;
    let wrongInLesson = 0;
    let qCount = 0;
    let isFlash = false;

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        const saved = localStorage.getItem('jiang_ultimate_v3');
        if(saved) user = JSON.parse(saved);

        // é˜²é‡æ•´æ©Ÿåˆ¶
        if(sessionStorage.getItem('lesson_running')) {
            user.energy = Math.max(0, user.energy - 10);
            alert("åµæ¸¬åˆ°é‡æ•´ï¼é«”åŠ›å·²å¼·åˆ¶æ‰£é™¤ã€‚");
        }
        
        checkHoliday();
        updateUI();
        switchTeacher('sci');
    };

    function checkHoliday() {
        const m = new Date().getMonth() + 1;
        if([1,2,7,8].includes(m)) user.energy = 100; // å¯’æš‘å‡é«”åŠ›è‡ªå‹•è£œæ»¿
    }

    function switchTeacher(t) {
        currentT = t;
        document.getElementById('pic-sci').style.display = t === 'sci' ? 'block' : 'none';
        document.getElementById('pic-art').style.display = t === 'art' ? 'block' : 'none';
        document.getElementById('nav-sci').className = t === 'sci' ? 'nav-btn active' : 'nav-btn';
        document.getElementById('nav-art').className = t === 'art' ? 'nav-btn active' : 'nav-btn';
        
        applyAutoDress();
        updateUI();
    }

    function applyAutoDress() {
        const lv = currentT === 'sci' ? user.sci_lv : user.art_lv;
        const dressIndex = Math.min(lv, 3);
        const dressName = dressLibrary[currentT][dressIndex];
        document.getElementById('talk').innerText = `æˆ‘æ˜¯${currentT==='sci'?'æ±Ÿéˆ´':'æ±Ÿä¾'}ã€‚ç›®å‰ç©¿è‘—ï¼š${dressName}ã€‚`;
        
        // ç”¨é¡è‰²æ¨¡æ“¬è£™è£è®ŠåŒ–
        const colors = ["#E0F7FA", "#B2EBF2", "#80DEEA", "#FFFFFF"];
        document.getElementById('layer-dress').style.backgroundColor = colors[dressIndex];
    }

    function startLesson() {
        if(user.energy < 20) return alert("é«”åŠ›ä¸è¶³ï¼åˆ·20é¡Œè£œèƒ½é¡Œåº«æ–¹å¯ç¹¼çºŒã€‚");
        
        isLessonActive = true;
        sessionStorage.setItem('lesson_running', 'true');
        isFlash = Math.random() < 0.2; // 20% å¿«é–ƒ
        document.getElementById('flash-alert').style.display = isFlash ? 'block' : 'none';
        
        qCount = 0;
        wrongInLesson = 0;
        nextQuestion();
    }

    function nextQuestion() {
        qCount++;
        document.getElementById('q-text').innerText = `ç¬¬ ${qCount}/10 é¡Œï¼š${currentT==='sci'?'(ç†ç§‘) å…‰çš„æŠ˜å°„å®šå¾‹æ˜¯ï¼Ÿ':'(æ–‡ç§‘) å”è©©ä¸‰ç™¾é¦–ä¹‹é¦–æ˜¯ï¼Ÿ'}`;
        const box = document.getElementById('options');
        box.innerHTML = "";
        ["é¸é … A", "é¸é … B", "é¸é … C"].forEach((txt, i) => {
            let b = document.createElement('button');
            b.className = "btn";
            b.innerText = txt;
            b.onclick = () => handleAns(i === 0);
            box.appendChild(b);
        });
    }

    function handleAns(isCorrect) {
        if(!isCorrect) wrongInLesson++;
        if(qCount < 10) nextQuestion();
        else finishLesson();
    }

    function finishLesson() {
        isLessonActive = false;
        sessionStorage.removeItem('lesson_running');
        user.energy -= 20;

        const errRate = wrongInLesson / 10;
        if(errRate <= 0.3) {
            user.coins += isFlash ? 1000 : 200;
            if(currentT === 'sci') user.sci_lv++; else user.art_lv++;
            
            if(isFlash) {
                const prize = shopItems[Math.floor(Math.random()*shopItems.length)];
                if(!user.inventory.includes(prize.id)) {
                    user.inventory.push(prize.id);
                    alert(`ğŸ”¥ å¿«é–ƒæˆåŠŸï¼ç²å¾—é™å®šé«®é£¾ï¼š${prize.name}`);
                }
            }
            alert(`èª²ç¨‹å®Œæˆï¼è§£é–ä¸‹ä¸€å¥—è£™è£ï¼Œç²å¾—é‡‘å¹£ã€‚`);
        } else {
            alert(`éŒ¯èª¤ç‡é” ${errRate*100}%ï¼Œæ±Ÿè€å¸«æ²’æ”¶äº†çå‹µã€‚é«”åŠ›ç…§æ¨£æ‰£é™¤ã€‚`);
        }
        
        save();
        updateUI();
        applyAutoDress();
        resetHome();
    }

    function resetHome() {
        document.getElementById('q-text').innerText = "æœ¬å ‚èª²çµæŸï¼Œä¼‘æ¯ä¸€ä¸‹å§ã€‚";
        document.getElementById('options').innerHTML = `<button class="btn" onclick="startLesson()">é–‹å§‹ä¸‹ä¸€å ‚èª²</button>`;
    }

    function openShop() {
        let msg = "ã€é‡‘å¹£å•†åŸ / æ›è£ã€‘\nç›®å‰é‡‘å¹£ï¼š" + user.coins + "\n\nå¯è³¼è²·ï¼š\n";
        shopItems.forEach(item => {
            msg += `${item.id}: ${item.name} (${item.price}ğŸª™)\n`;
        });
        msg += "\nè¼¸å…¥IDè³¼è²·ï¼Œæˆ–è¼¸å…¥å·²æ“æœ‰çš„IDé€²è¡Œæ›è£ã€‚";
        const choice = prompt(msg);
        
        const item = shopItems.find(i => i.id === choice);
        if(item) {
            if(user.inventory.includes(choice)) {
                user.wearingHair = item.icon;
                alert("æ›è£æˆåŠŸï¼");
            } else if(user.coins >= item.price) {
                user.coins -= item.price;
                user.inventory.push(choice);
                user.wearingHair = item.icon;
                alert("è³¼è²·ä¸¦ç©¿æˆ´æˆåŠŸï¼");
            } else {
                alert("é‡‘å¹£ä¸è¶³ï¼");
            }
        }
        save();
        updateUI();
    }

    function updateUI() {
        document.getElementById('u-coins').innerText = user.coins;
        document.getElementById('e-fill').style.width = user.energy + "%";
        document.getElementById('layer-hair').innerText = user.wearingHair;
        localStorage.setItem('jiang_ultimate_v3', JSON.stringify(user));
    }

    function save() { localStorage.setItem('jiang_ultimate_v3', JSON.stringify(user)); }
</script>
</body>
</html>
