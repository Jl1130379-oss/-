<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚</title>
    <style>
        :root { --main: #2c3e50; --gold: #d4af37; --white: rgba(255,255,255,0.95); --error: #ff4757; }
        * { box-sizing: border-box; font-family: "PingFang TC", sans-serif; transition: 0.3s ease; }
        body { margin: 0; background: #1a1a1a; color: #333; height: 100vh; overflow: hidden; }

        #world-bg { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.3)), url('æ±Ÿè€å¸«åˆç…§.jpg'); background-size: cover; background-position: center; z-index: -1; }
        
        /* é›ªèŠ±ç³»çµ± */
        .snowflake { position: fixed; top: -10%; color: white; cursor: pointer; z-index: 1000; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* å°èˆª */
        #sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 200px; background: var(--white); display: flex; flex-direction: column; padding-top: 40px; z-index: 100; box-shadow: 2px 0 20px rgba(0,0,0,0.2); }
        .nav-link { padding: 18px 25px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #eee; }
        .nav-link:hover { background: var(--main); color: white; }

        /* ç‹€æ…‹æ¬„ */
        .status-bar { position: fixed; top: 20px; right: 30px; display: flex; gap: 15px; z-index: 100; }
        .stat-box { background: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* AI ç¾¤èŠè¦–çª— */
        #chat-window { position: fixed; bottom: 20px; right: 20px; width: 380px; height: 550px; background: #f0f2f5; border-radius: 25px; display: none; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); z-index: 500; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .chat-header { background: var(--main); color: white; padding: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; }
        .msg.teacher { background: white; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { background: var(--main); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ctrl { padding: 15px; background: white; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { display: flex; gap: 8px; }
        input#user-text { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none; }

        /* ç­”é¡Œé®ç½© */
        #quiz-overlay { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .btn-opt { padding: 15px 40px; margin: 10px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #eee; background: white; cursor: pointer; width: 300px; }
        .btn-opt:hover { border-color: var(--gold); background: #fffcf0; }
    </style>
</head>
<body onload="init()">

<div id="world-bg"></div>
<div id="snow-container"></div>

<div id="sidebar">
    <div style="text-align:center; padding:20px; font-weight:900; color:var(--gold); font-size:1.2rem;">æ±Ÿå®¶æ™ºæ…§åŸå¸‚</div>
    <div class="nav-link" onclick="openChat('ling')">ğŸ‘©â€âš•ï¸ æ±Ÿéˆ´è€å¸« (ç†)</div>
    <div class="nav-link" onclick="openChat('yi')">ğŸ¨ æ±Ÿä¾è€å¸« (æ–‡)</div>
    <div class="nav-link" onclick="alert('æ‹æ”æˆåŠŸï¼å·²å­˜å…¥ç›¸ç°¿')">ğŸ“¸ æ‹æ”å”¯ç¾ç•«é¢</div>
    <div class="nav-link" onclick="alert('å•†å ´å»ºè¨­ä¸­...')">ğŸ›’ åŸå¸‚å•†å ´</div>
</div>

<div class="status-bar">
    <div class="stat-box" onclick="refill()" style="cursor:pointer;">âš¡ <span id="sta">10</span></div>
    <div class="stat-box">ğŸª™ <span id="coin">500</span></div>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span id="chat-name">æ±Ÿè€å¸«ç¾¤èŠ</span>
        <span onclick="document.getElementById('chat-window').style.display='none'" style="cursor:pointer;">âœ•</span>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-ctrl">
        <div class="chat-input-area">
            <input type="text" id="user-text" placeholder="è·Ÿè€å¸«èŠèŠ..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" style="border:none; background:var(--gold); color:white; border-radius:10px; padding:0 15px;">ç™¼é€</button>
        </div>
        <div style="display:flex; gap:5px;">
            <button onclick="prepareQuiz('brush')" style="flex:1; padding:8px; font-size:0.8rem;">æˆ‘è¦åˆ·é¡Œ</button>
            <button onclick="prepareQuiz('compete')" style="flex:1; padding:8px; font-size:0.8rem;">æˆ‘æƒ³æŒ‘æˆ°</button>
        </div>
    </div>
</div>

<div id="quiz-overlay">
    <h3 id="q-lv-title">åœ‹å°é›£åº¦</h3>
    <div id="q-progress" style="margin-bottom:20px; color:var(--gold); font-weight:bold;">ç¬¬ 1 / 10 é¡Œ</div>
    <p id="q-content" style="font-size:1.4rem; padding:0 10%; text-align:center;"></p>
    <div id="q-options"></div>
    <p id="q-warn" style="color:var(--error); margin-top:40px; font-size:0.8rem;"></p>
</div>

<script>
    let state = {
        coins: 500, stamina: 10, teacher: '', isAdmin: false,
        quiz: { active: false, current: 0, errors: 0, lv: 1, type: '' }
    };

    function init() {
        // é‡æ•´ç½°å‰‡é‚è¼¯ï¼šåˆ©ç”¨ sessionStorage åµæ¸¬éæ³•é‡è¼‰
        if (sessionStorage.getItem('inQuiz') === 'true') {
            state.stamina = Math.max(0, parseInt(localStorage.getItem('sta') || 10) - 2);
            alert("âš ï¸ åµæ¸¬åˆ°ç­”é¡Œä¸­é€”éæ³•é‡æ–°æ•´ç†ï¼å·²æ‰£é™¤ 2 é»é«”åŠ›ä½œç‚ºç½°å‰‡ã€‚");
            save();
        }
        updateUI();
        setInterval(createSnow, 400);
        window.onblur = () => { if(state.quiz.active) { alert("ç¦æ­¢é›¢é–‹é é¢ï¼"); } };
    }

    function openChat(t) {
        state.teacher = t;
        document.getElementById('chat-window').style.display = 'flex';
        const name = t === 'ling' ? 'æ±Ÿéˆ´' : 'æ±Ÿä¾';
        document.getElementById('chat-name').innerText = `èˆ‡ ${name} è€å¸«å°è©±`;
        addMsg('teacher', `ä½ å¥½å•Šï¼æˆ‘æ˜¯${name}ã€‚ä»Šå¤©æƒ³èŠèŠå¿ƒæƒ…ï¼Œé‚„æ˜¯æƒ³åˆ·é¡Œè€ƒé©—è‡ªå·±ï¼Ÿ`);
    }

    function sendChat() {
        const input = document.getElementById('user-text');
        if(!input.value) return;
        addMsg('user', input.value);
        
        // ç°¡æ˜“ AI å›è¦†æ¨¡æ“¬
        const reply = [
            "è½èµ·ä¾†å¾ˆæœ‰æ„æ€å‘¢ï¼Œå¦³ç¸½æ˜¯é€™éº¼æœ‰æƒ³æ³•ã€‚",
            "é€™å°±æ˜¯æ±Ÿå®¶ç²¾ç¥ï¼ç„¡è«–å¦‚ä½•æˆ‘éƒ½æœƒæ”¯æŒå¦³çš„ã€‚",
            "åŸä¾†æ˜¯é€™æ¨£å•Šï¼Œé‚£è¦ä¸è¦å–æ¯èŒ¶æ”¾é¬†ä¸€ä¸‹ï¼Ÿ",
            "é€™è®“æˆ‘æƒ³èµ·äº†ä¸€å¥é†«å­¸/æ–‡å­¸ä¸Šçš„åè¨€..."
        ];
        setTimeout(() => addMsg('teacher', reply[Math.floor(Math.random()*reply.length)]), 800);
        input.value = '';
    }

    function prepareQuiz(mode) {
        if(state.stamina <= 0) return addMsg('teacher', "é«”åŠ›è€—ç›¡äº†ï¼Œå»ä¼‘æ¯ä¸€ä¸‹å§ã€‚");
        if(mode === 'brush') {
            let lv = prompt("è«‹é¸æ“‡é›£åº¦ (1:åœ‹å° 50å¹£, 2:åœ‹ä¸­, 3:é«˜ä¸­, 4:å¤§å­¸, 5:ç¢©åš 200å¹£)");
            if(lv >= 1 && lv <= 5) startQuiz(parseInt(lv), 'brush');
        } else {
            startQuiz(5, 'compete');
        }
    }

    function startQuiz(lv, type) {
        state.stamina--;
        state.quiz = { active: true, current: 1, errors: 0, lv: lv, type: type };
        sessionStorage.setItem('inQuiz', 'true');
        document.getElementById('quiz-overlay').style.display = 'flex';
        loadQuestion();
        updateUI();
    }

    function loadQuestion() {
        const lvs = ['', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'ç¢©åš'];
        document.getElementById('q-lv-title').innerText = lvs[state.quiz.lv] + (state.quiz.type==='compete'?'ã€ç«¶è³½ã€‘':'æ—¥å¸¸é¡Œ');
        document.getElementById('q-progress').innerText = `ç¬¬ ${state.quiz.current} / 10 é¡Œ (éŒ¯èª¤æ¬¡æ•¸: ${state.quiz.errors})`;
        document.getElementById('q-content').innerText = `é€™æ˜¯ç¬¬ ${state.quiz.current} é¡Œçš„å…§å®¹... (å‡è¨­é¡Œç›®æ•¸æ“šå·²åŠ è¼‰)`;
        document.getElementById('q-warn').innerText = (state.quiz.lv >= 4) ? "âš–ï¸ é«˜éšé¡Œç›®ï¼šä¸è¨ˆæ™‚ï¼Œä½†ç¦æ­¢ä¸€åˆ‡ä½œå¼Šèˆ‡åˆ‡é è¡Œç‚ºã€‚" : "â³ æ­¤é›£åº¦éœ€åœ¨ 20 ç§’å…§ä½œç­”ã€‚";
        
        const box = document.getElementById('q-options');
        box.innerHTML = '';
        ['æ­£ç¢ºé¸é …', 'éŒ¯èª¤é¸é …'].sort(()=>Math.random()-0.5).forEach(txt => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt';
            btn.innerText = txt;
            btn.onclick = () => handleAns(txt === 'æ­£ç¢ºé¸é …');
            box.appendChild(btn);
        });
    }

    function handleAns(isRight) {
        if(!isRight) state.quiz.errors++;
        if(state.quiz.current < 10) {
            state.quiz.current++;
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    function finishQuiz() {
        sessionStorage.setItem('inQuiz', 'false');
        const errRate = (state.quiz.errors / 10);
        let reward = state.quiz.lv * 40 + 10; // 50 to 200
        if(state.quiz.type === 'compete') reward = 1000;

        if(errRate > 0.3) {
            alert(`æ±Ÿè€å¸«ï¼šé€™å¥—é¡Œå¦³éŒ¯äº† ${state.quiz.errors} é¡Œï¼ŒéŒ¯èª¤ç‡è¶…é 30%ï¼Œé«”åŠ›å·²æ‰£é™¤ä½†ç„¡æ³•çµ¦äºˆçå‹µå–”ã€‚è¦å†åŠ æ²¹ï¼`);
        } else {
            state.coins += (state.isAdmin ? reward * 10 : reward);
            alert(`æ±Ÿè€å¸«ï¼šå¤ªæ£’äº†ï¼å¦³å®Œç¾çš„å®Œæˆäº†æŒ‘æˆ°ï¼Œç²å¾—é‡‘å¹£ ğŸª™${reward}ï¼`);
        }
        
        state.quiz.active = false;
        document.getElementById('quiz-overlay').style.display = 'none';
        updateUI();
        save();
    }

    function createSnow() {
        const s = document.createElement('div');
        s.className = 'snowflake'; s.innerText = 'â„ï¸';
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = (Math.random()*3+4)+'s';
        s.onclick = () => {
            if(prompt("æ±Ÿå®¶æ¬Šé™é©—è­‰ï¼š") === "æ±Ÿæ†¶å©·") {
                state.isAdmin = true; state.coins += 1000; updateUI();
                alert("ğŸ‘‘ æ­¡è¿ç®¡ç†è€…æ±Ÿæ†¶å©·ï¼1æŠ˜æ¬Šé™èˆ‡ AI æ·±åº¦å°è©±æ¨¡çµ„å·²è§£é–ã€‚");
            }
        };
        document.getElementById('snow-container').appendChild(s);
        setTimeout(()=>s.remove(), 7000);
    }

    function addMsg(role, text) {
        const box = document.getElementById('chat-msgs');
        box.innerHTML += `<div class="msg ${role}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    function updateUI() {
        document.getElementById('coin').innerText = state.coins;
        document.getElementById('sta').innerText = state.stamina;
    }
    function refill() { state.stamina = 10; updateUI(); alert("æ±Ÿéˆ´ï¼šé«”åŠ›å·²å……æ»¿ï¼"); }
    function save() { localStorage.setItem('sta', state.stamina); }
</script>
</body>
</html>
