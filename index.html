<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚ - å®˜æ–¹ç©©å®šç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --main: #5a7d9b; --accent: #e6b8a2; --gold: #d4af37;
            --white: rgba(255, 255, 255, 0.95); --err: #ff4757;
        }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; transition: 0.3s; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }

        /* èƒŒæ™¯å±¤ */
        #bg-layer {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('IMG_7210.jpg');
            background-size: cover; background-position: center; z-index: -2;
        }

        /* é›ªèŠ±å±¤ï¼šæœ€é«˜å„ªå…ˆæ¬Š */
        #snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }
        .snowflake {
            position: absolute; top: -10%; color: white; cursor: pointer;
            pointer-events: auto; user-select: none; animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* 1. ç™»å…¥é é¢ */
        #auth-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center; z-index: 5000;
        }
        .auth-card {
            background: var(--white); padding: 40px; border-radius: 25px;
            width: 380px; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; }
        .auth-btn { width: 100%; padding: 12px; background: var(--main); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }

        /* 2. åŸå¸‚ç¸½å…¥å£ Dashboard */
        #dashboard {
            display: none; height: 100vh; padding: 80px 40px;
            grid-template-columns: repeat(3, 1fr); gap: 30px; z-index: 10;
        }
        .city-node {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.3); border-radius: 25px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; cursor: pointer; text-decoration: none; position: relative;
        }
        .city-node:hover { background: var(--white); color: var(--main); transform: translateY(-10px); }
        .city-node i { font-size: 3.5rem; margin-bottom: 20px; }
        .city-node b { font-size: 1.3rem; }

        /* ç‹€æ…‹ HUD */
        #hud { position: fixed; top: 25px; right: 30px; display: none; gap: 15px; z-index: 4000; }
        .hud-item { background: var(--white); padding: 10px 25px; border-radius: 50px; font-weight: 900; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* 3. AI ç¾¤èŠè¦–çª— */
        #chat-window {
            position: fixed; bottom: 30px; right: 30px; width: 400px; height: 600px;
            background: #f8f9fa; border-radius: 25px; display: none; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4); z-index: 3000; overflow: hidden;
        }
        .chat-header { background: var(--main); color: white; padding: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #f0f2f5; }
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; }
        .msg.teacher { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-input-area { padding: 15px; background: white; border-top: 1px solid #eee; }
        .chat-actions { display: flex; gap: 8px; margin-top: 10px; }
        .chat-actions button { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--main); background: white; color: var(--main); font-weight: bold; cursor: pointer; font-size: 0.8rem; }

        /* 4. ç­”é¡Œèˆ‡æ¨¡çµ„é®ç½© */
        .full-modal {
            position: fixed; inset: 0; background: white; z-index: 4500;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .quiz-box { text-align: center; width: 80%; max-width: 600px; }
        .opt-btn { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; background: #fff; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
        .opt-btn:hover { border-color: var(--gold); background: #fffcf0; }
    </style>
</head>
<body onload="initSystem()">

<div id="bg-layer"></div>
<div id="snow-container"></div>

<div id="auth-screen">
    <div class="auth-card">
        <h2 style="color:var(--main)">æ±Ÿå®¶æ™ºæ…§åŸå¸‚</h2>
        <p>è«‹è¼¸å…¥é€šè¡Œè­‰é€²å…¥</p>
        <input type="text" id="username" class="auth-input" placeholder="æ‚¨çš„åå­—">
        <input type="password" id="password" class="auth-input" placeholder="è¨ªå•å¯†ç¢¼">
        <button class="auth-btn" onclick="login()">é–‹å§‹å­¸ç¿’ä¹‹æ—…</button>
    </div>
</div>

<div id="hud">
    <div class="hud-item" onclick="refillStamina()" style="cursor:pointer">âš¡ <span id="sta-val">10</span></div>
    <div class="hud-item">ğŸª™ <span id="coin-val">500</span></div>
    <div class="hud-item" onclick="location.reload()" style="cursor:pointer"><i class="fas fa-home"></i></div>
</div>

<div id="dashboard">
    <div class="city-node" onclick="openChat('ling')">
        <i class="fas fa-microscope"></i>
        <b>ç†ç§‘æ•™å®¤ (æ±Ÿéˆ´)</b>
    </div>
    <div class="city-node" onclick="openChat('yi')">
        <i class="fas fa-feather-alt"></i>
        <b>æ–‡ç§‘æ²™é¾ (æ±Ÿä¾)</b>
    </div>
    <div class="city-node" onclick="alert('é€²å…¥åº­é™¢æ‹ç…§...')">
        <i class="fas fa-tree"></i>
        <b>æ±Ÿå®¶åº­é™¢</b>
    </div>
    <div class="city-node" onclick="alert('ç›¸ç°¿åŠ è¼‰ä¸­...')">
        <i class="fas fa-images"></i>
        <b>å›æ†¶ç›¸ç°¿</b>
    </div>
    <div class="city-node" onclick="alert('å•†å ´å»ºè¨­ä¸­...')">
        <i class="fas fa-store"></i>
        <b>åŸå¸‚å•†å ´</b>
    </div>
    <div class="city-node" onclick="alert('å‰å¾€æ›´è¡£å®¤...')">
        <i class="fas fa-tshirt"></i>
        <b>ç§äººæ›´è¡£å®¤</b>
    </div>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span id="teacher-name">èˆ‡æ±Ÿè€å¸«èŠèŠ</span>
        <span onclick="toggleChat(false)" style="cursor:pointer">âœ•</span>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-input-area">
        <div style="display:flex; gap:8px;">
            <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <button onclick="sendMsg()" style="padding:10px 15px; background:var(--main); color:white; border:none; border-radius:8px;">ç™¼é€</button>
        </div>
        <div class="chat-actions">
            <button onclick="startAction('brush')">åˆ·é¡Œæ¨¡å¼</button>
            <button onclick="startAction('compete')">ç«¶è³½æ¨¡å¼ (1âš¡)</button>
        </div>
    </div>
</div>

<div id="quiz-modal" class="full-modal">
    <div class="quiz-box">
        <h2 id="q-title" style="color:var(--main)"></h2>
        <h4 id="q-prog" style="color:var(--gold)"></h4>
        <p id="q-text" style="font-size:1.5rem; margin:30px 0;"></p>
        <div id="q-opts"></div>
        <div id="q-timer" style="margin-top:20px; font-weight:bold; color:var(--err)"></div>
    </div>
</div>

<script>
    let state = {
        coins: 500, stamina: 10, teacher: '', isAdmin: false,
        quiz: { active: false, current: 0, errors: 0, lv: 1, type: '' }
    };

    function initSystem() {
        // 1. ä½œå¼Šåµæ¸¬
        if (sessionStorage.getItem('inQuiz')) {
            state.stamina = Math.max(0, (parseInt(localStorage.getItem('sta')) || 10) - 2);
            alert("âš ï¸ åµæ¸¬åˆ°éæ³•åˆ·æ–°ï¼å·²æ‰£é™¤ 2 é»é«”åŠ›ã€‚");
            saveState();
        } else {
            state.stamina = parseInt(localStorage.getItem('sta')) || 10;
            state.coins = parseInt(localStorage.getItem('coin')) || 500;
        }
        updateUI();
        setInterval(spawnSnow, 400);

        // 2. åˆ‡é åµæ¸¬
        window.onblur = () => { if(state.quiz.active) console.warn("åµæ¸¬åˆ°é›¢é–‹ï¼"); };
    }

    // --- ç™»å…¥èˆ‡ Dashboard ---
    function login() {
        const name = document.getElementById('username').value;
        if(!name) return alert("è«‹è¼¸å…¥åå­—");
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'grid';
        document.getElementById('hud').style.display = 'flex';
        alert(`æ­¡è¿ï¼Œ${name}ï¼å…©ä½æ±Ÿè€å¸«å·²ç¶“ç­‰å€™å¤šæ™‚ã€‚`);
    }

    // --- é›ªèŠ±ç³»çµ± (ç®¡ç†è€…å…¥å£) ---
    function spawnSnow() {
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.innerHTML = 'â„ï¸';
        s.style.left = Math.random() * 95 + 'vw';
        s.style.fontSize = (Math.random() * 20 + 15) + 'px';
        s.style.animationDuration = (Math.random() * 3 + 5) + 's';
        s.onclick = (e) => {
            e.stopPropagation();
            const pw = prompt("éš±è—æ¬Šé™é©—è­‰ï¼š");
            if(pw === "æ±Ÿæ†¶å©·") {
                state.isAdmin = true; state.coins += 9999; updateUI();
                alert("ğŸ‘‘ ç®¡ç†è€…æ±Ÿæ†¶å©·ï¼ŒåŸå¸‚å·²ç‚ºæ‚¨å…¨é¢è§£é–ã€‚");
            }
        };
        document.getElementById('snow-container').appendChild(s);
        setTimeout(() => s.remove(), 8000);
    }

    // --- AI éš¨æ„èŠ ---
    function openChat(t) {
        state.teacher = t;
        const name = t === 'ling' ? 'æ±Ÿéˆ´' : 'æ±Ÿä¾';
        document.getElementById('teacher-name').innerText = `èˆ‡ ${name} è€å¸«èŠèŠ`;
        document.getElementById('chat-window').style.display = 'flex';
        addMsg('teacher', `ä½ å¥½ï¼æˆ‘æ˜¯${name}ã€‚ä»Šå¤©æƒ³èŠé»ä»€éº¼ï¼Œé‚„æ˜¯ç›´æ¥é–‹å§‹è€ƒé©—ï¼Ÿ`);
    }

    function sendMsg() {
        const input = document.getElementById('chat-input');
        if(!input.value) return;
        addMsg('user', input.value);
        const replies = ["å¾ˆæœ‰è¶£çš„æƒ³æ³•ã€‚","æˆ‘æ˜ç™½äº†ï¼Œå¦³ç¸½æ˜¯èƒ½çµ¦æˆ‘é©šå–œã€‚","é€™å°±æ˜¯æ±Ÿå®¶äººçš„é»˜å¥‘ã€‚"];
        setTimeout(() => addMsg('teacher', replies[Math.floor(Math.random()*replies.length)]), 800);
        input.value = '';
    }

    function addMsg(role, text) {
        const box = document.getElementById('chat-msgs');
        box.innerHTML += `<div class="msg ${role}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // --- åˆ·é¡Œèˆ‡ç«¶è³½ç³»çµ± ---
    function startAction(mode) {
        if(state.stamina <= 0) return alert("é«”åŠ›ä¸è¶³ï¼");
        if(mode === 'brush') {
            const lv = prompt("é¸æ“‡é›£åº¦ (1:åœ‹å° 50å¹£ ... 5:ç¢©åš 200å¹£)");
            if(lv >= 1 && lv <= 5) startQuiz(parseInt(lv), 'brush');
        } else {
            if(confirm("æŒ‘æˆ°ç«¶è³½é¡Œï¼Ÿåªéœ€ 1âš¡ï¼Œä½†éŒ¯èª¤ç‡éé«˜ç„¡çå‹µï¼")) startQuiz(5, 'compete');
        }
    }

    function startQuiz(lv, type) {
        state.stamina -= 1;
        state.quiz = { active: true, current: 1, errors: 0, lv: lv, type: type };
        sessionStorage.setItem('inQuiz', 'true');
        document.getElementById('quiz-modal').style.display = 'flex';
        loadQ();
        updateUI();
    }

    function loadQ() {
        const lvs = ['', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'ç¢©åš'];
        document.getElementById('q-title').innerText = `${lvs[state.quiz.lv]}æŒ‘æˆ° (${state.quiz.type === 'compete' ? 'ç«¶è³½' : 'åˆ·é¡Œ'})`;
        document.getElementById('q-prog').innerText = `ç¬¬ ${state.quiz.current} / 10 é¡Œ`;
        document.getElementById('q-text').innerText = state.teacher === 'ling' ? "ã€ç†ç§‘ã€‘ç´°èƒä¸­è² è²¬ç”¢ç”Ÿèƒ½é‡çš„æ˜¯ï¼Ÿ" : "ã€æ–‡ç§‘ã€‘ã€Šç´…æ¨“å¤¢ã€‹çš„ä½œè€…æ˜¯ï¼Ÿ";
        
        const opts = ["æ­£ç¢ºç­”æ¡ˆ", "å¹²æ“¾é¸é …"].sort(() => Math.random() - 0.5);
        const box = document.getElementById('q-opts');
        box.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => handleAns(o === "æ­£ç¢ºç­”æ¡ˆ");
            box.appendChild(btn);
        });

        const timer = document.getElementById('q-timer');
        timer.innerText = (state.quiz.lv >= 4 || state.quiz.type === 'compete') ? "âŒ› ä¸è¨ˆæ™‚æŒ‘æˆ° (ç¦æ­¢åˆ‡åˆ†é )" : "âŒ› é™æ™‚ï¼š20ç§’";
    }

    function handleAns(right) {
        if(!right) state.quiz.errors++;
        if(state.quiz.current < 10) {
            state.quiz.current++;
            loadQ();
        } else {
            finishQuiz();
        }
    }

    function finishQuiz() {
        sessionStorage.removeItem('inQuiz');
        const errRate = state.quiz.errors / 10;
        let reward = state.quiz.lv * 37.5 + 12.5; 
        if(state.quiz.type === 'compete') reward = 500;

        if(errRate > 0.3) {
            alert(`æ±Ÿè€å¸«ï¼šå¦³éŒ¯äº† ${state.quiz.errors} é¡Œï¼ŒéŒ¯èª¤ç‡è¶…é 30%ï¼Œæœ¬æ¬¡æŒ‘æˆ°ç„¡çå‹µã€‚`);
        } else {
            if(state.isAdmin) reward *= 10;
            state.coins += Math.round(reward);
            alert(`ğŸ‰ å¤ªæ£’äº†ï¼ç²å¾—é‡‘å¹£ ğŸª™${Math.round(reward)}`);
        }
        
        state.quiz.active = false;
        document.getElementById('quiz-modal').style.display = 'none';
        updateUI();
        saveState();
    }

    // --- è¼”åŠ© ---
    function updateUI() {
        document.getElementById('sta-val').innerText = state.stamina;
        document.getElementById('coin-val').innerText = state.coins;
    }
    function saveState() {
        localStorage.setItem('sta', state.stamina);
        localStorage.setItem('coin', state.coins);
    }
    function refillStamina() { state.stamina = 10; updateUI(); saveState(); alert("æ±Ÿéˆ´ï¼šé«”åŠ›å……æ»¿äº†ï¼"); }
    function toggleChat(s) { document.getElementById('chat-window').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
