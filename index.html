<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚ - çµ‚æ¥µ AI ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --gold: #d4af37; --white: rgba(255,255,255,0.95); --err: #ff4757; }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { margin: 0; background: #000; color: #333; height: 100vh; overflow: hidden; }

        /* èƒŒæ™¯ç•«é¢¨ï¼šèåˆå¦³æä¾›çš„æ±Ÿå®¶å§å¦¹é¢¨æ ¼ */
        #world-bg { 
            position: fixed; inset: 0; 
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.4)), url('æ±Ÿè€å¸«åˆç…§.jpg'); 
            background-size: cover; background-position: center; z-index: -1; 
        }

        /* æ¼«å¤©é›ªèŠ± */
        .snowflake { position: fixed; top: -10%; color: white; cursor: pointer; z-index: 1000; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* å·¦å´é¸å–® */
        #sidebar { 
            position: fixed; left: 0; top: 0; bottom: 0; width: 220px; 
            background: var(--white); backdrop-filter: blur(15px);
            display: flex; flex-direction: column; padding-top: 50px; z-index: 100; 
        }
        .nav-link { 
            padding: 20px 25px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #eee; 
            display: flex; align-items: center; gap: 10px; color: var(--main); text-decoration: none;
        }
        .nav-link:hover { background: var(--main); color: white; }

        /* é ‚éƒ¨ç‹€æ…‹ï¼šé›»æ± èˆ‡é‡‘å¹£ */
        .status-bar { position: fixed; top: 20px; right: 30px; display: flex; gap: 15px; z-index: 100; }
        .stat-box { 
            background: white; padding: 12px 25px; border-radius: 50px; 
            font-weight: 900; box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            display: flex; align-items: center; gap: 8px; cursor: pointer;
        }

        /* AI ç¾¤èŠè¦–çª— */
        #chat-window { 
            position: fixed; bottom: 20px; right: 20px; width: 400px; height: 580px; 
            background: #f4f7f6; border-radius: 25px; display: none; flex-direction: column; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 500; overflow: hidden;
        }
        .chat-header { background: var(--main); color: white; padding: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 18px; border-radius: 15px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; }
        .msg.teacher { background: white; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #ddd; }
        .msg.user { background: var(--gold); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .chat-input { padding: 20px; background: white; border-top: 1px solid #eee; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input#user-input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        .action-row { display: flex; gap: 5px; }
        .action-row button { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--gold); background: white; color: var(--gold); font-weight: bold; cursor: pointer; }
        .action-row button:hover { background: var(--gold); color: white; }

        /* ç­”é¡Œç³»çµ±é®ç½© */
        #quiz-overlay { 
            position: fixed; inset: 0; background: white; z-index: 2000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .option-btn { 
            padding: 18px 40px; margin: 10px; font-size: 1.2rem; border-radius: 15px; 
            border: 2px solid #f0f0f0; background: white; cursor: pointer; width: 350px; 
        }
        .option-btn:hover { border-color: var(--gold); background: #fffcf0; }
    </style>
</head>
<body onload="initSystem()">

<div id="world-bg"></div>
<div id="snow-container"></div>

<div id="sidebar">
    <div style="text-align:center; padding:20px; font-weight:900; color:var(--gold); font-size:1.3rem;">æ±Ÿå®¶æ™ºæ…§åŸå¸‚</div>
    <div class="nav-link" onclick="openChat('ling')">ğŸ§ª ç†ç§‘æ•™ç ” (æ±Ÿéˆ´)</div>
    <div class="nav-link" onclick="openChat('yi')">ğŸ“š æ–‡ç§‘å“é‘‘ (æ±Ÿä¾)</div>
    <div class="nav-link" onclick="location.reload()">ğŸ¡ é‡å›æ±Ÿå®¶åº­é™¢</div>
    <div class="nav-link" onclick="alert('ç›¸ç°¿æ”¶è—ä¸­...')">ğŸ–¼ï¸ æ±Ÿè€å¸«ç›¸ç°¿</div>
    <div class="nav-link" onclick="alert('åŠŸèƒ½é–‹ç™¼ä¸­...')">ğŸ‘— ç§äººæ›´è¡£å®¤</div>
</div>

<div class="status-bar">
    <div class="stat-box" onclick="refillStamina()" title="é›»æ± ï¼šé»æ“Šè£œå……">âš¡ <span id="sta-val">10</span></div>
    <div class="stat-box">ğŸª™ <span id="coin-val">500</span></div>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span id="chat-title">æ±Ÿè€å¸«ç¾¤èŠ</span>
        <span onclick="toggleChat(false)" style="cursor:pointer;">âœ•</span>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-input">
        <div class="input-row">
            <input type="text" id="user-input" placeholder="æƒ³è·Ÿè€å¸«èªªä»€éº¼..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="background:var(--main); color:white; border:none; border-radius:8px; padding:0 15px;">ç™¼é€</button>
        </div>
        <div class="action-row">
            <button onclick="triggerAction('brush')">æˆ‘è¦åˆ·é¡Œ</button>
            <button onclick="triggerAction('compete')">æˆ‘æƒ³æŒ‘æˆ°ç«¶è³½</button>
        </div>
    </div>
</div>

<div id="quiz-overlay">
    <h2 id="quiz-title">é›£åº¦ï¼šåœ‹å°</h2>
    <div id="quiz-progress" style="color:var(--gold); font-weight:bold; font-size:1.1rem; margin-bottom:15px;">1 / 10</div>
    <p id="quiz-text" style="font-size:1.6rem; text-align:center; padding:0 10%; line-height:1.5; min-height:120px;"></p>
    <div id="quiz-options"></div>
    <div id="quiz-timer" style="margin-top:30px; font-weight:900; color:var(--err); font-size:1.5rem;"></div>
    <p style="color:#999; margin-top:20px; font-size:0.8rem;">âš ï¸ ä½œå¼Šåµæ¸¬ï¼šç¦æ­¢é‡æ•´é é¢æˆ–åˆ‡æ›æ¨™ç±¤é ã€‚</p>
</div>

<script>
    let state = {
        coins: 500, stamina: 10, teacher: '', isAdmin: false,
        quiz: { active: false, current: 0, errors: 0, lv: 1, type: '' }
    };

    const teacherProfiles = {
        ling: { name: "æ±Ÿéˆ´", greet: "ä½ å¥½ï¼Œæˆ‘æ˜¯æ±Ÿéˆ´ã€‚é†«å­¸çš„åš´è¬¹éœ€è¦å†·éœçš„é ­è…¦ï¼Œå¦³æº–å‚™å¥½äº†å—ï¼Ÿ" },
        yi: { name: "æ±Ÿä¾", greet: "å“ˆå›‰ï¼æˆ‘æ˜¯æ±Ÿä¾ã€‚è®“æˆ‘å€‘åœ¨æ–‡å­—èˆ‡è—è¡“çš„æµ·æ´‹è£¡æ‰¾åˆ°å¯§éœå§ã€‚" }
    };

    function initSystem() {
        // 1. é˜²é‡æ•´ä½œå¼Šåµæ¸¬
        if (sessionStorage.getItem('isGuilty') === 'true') {
            state.stamina = Math.max(0, (parseInt(localStorage.getItem('savedSta')) || 10) - 2);
            alert("ğŸš¨ ç³»çµ±åµæ¸¬åˆ°æ‚¨åœ¨æŒ‘æˆ°ä¸­éæ³•é‡æ•´ï¼å·²æ‰£é™¤ 2 é»é«”åŠ›ä½œç‚ºè™•ç½°ã€‚");
            saveToLocal();
        } else {
            state.stamina = parseInt(localStorage.getItem('savedSta')) || 10;
        }
        
        updateUI();
        setInterval(createSnow, 400);

        // 2. é˜²åˆ‡é åµæ¸¬
        window.onblur = () => { if(state.quiz.active) console.log("æ±Ÿè€å¸«ï¼šæ³¨æ„å°ˆæ³¨åŠ›ï¼"); };
    }

    // AI ç¾¤èŠèˆ‡éš¨æ„èŠé‚è¼¯
    function openChat(t) {
        state.teacher = t;
        toggleChat(true);
        document.getElementById('chat-title').innerText = `èˆ‡ ${teacherProfiles[t].name} å°è©±`;
        addChatMsg('teacher', teacherProfiles[t].greet);
    }

    function sendMessage() {
        const input = document.getElementById('user-input');
        if(!input.value.trim()) return;
        addChatMsg('user', input.value);
        
        // æ¨¡æ“¬ AI æ‘¯å‹å›è¦†
        const thoughts = [
            "æˆ‘ä¹Ÿåœ¨æƒ³é€™ä»¶äº‹å‘¢ï¼Œçœ‹ä¾†æˆ‘å€‘å¾ˆæœ‰é»˜å¥‘ã€‚",
            "å¦³ä»Šå¤©çœ‹èµ·ä¾†ç‰¹åˆ¥æœ‰ç²¾ç¥ï¼Œæ˜¯å› ç‚ºå­¸ç¿’æœ‰é€²æ­¥å—ï¼Ÿ",
            "é€™å°±æ˜¯æ±Ÿå®¶ç²¾ç¥ï¼Œç„¡è«–å¦‚ä½•ï¼Œæ±Ÿè€å¸«éƒ½æœƒé™ªè‘—å¦³ã€‚",
            "é›–ç„¶æœ‰é›£åº¦ï¼Œä½†æˆ‘ç›¸ä¿¡å¦³çš„æ½›åŠ›ã€‚"
        ];
        setTimeout(() => addChatMsg('teacher', thoughts[Math.floor(Math.random()*thoughts.length)]), 800);
        input.value = '';
    }

    function addChatMsg(role, text) {
        const box = document.getElementById('chat-msgs');
        box.innerHTML += `<div class="msg ${role}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // æ ¸å¿ƒå­¸ç¿’é‚è¼¯
    function triggerAction(mode) {
        if(state.stamina <= 0) return addChatMsg('teacher', "é«”åŠ›è€—ç›¡äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å†ä¾†å§ã€‚");
        
        if(mode === 'brush') {
            const lv = prompt("è«‹é¸æ“‡æŒ‘æˆ°é›£åº¦ï¼š\n1.åœ‹å°(50ğŸª™)\n2.åœ‹ä¸­\n3.é«˜ä¸­\n4.å¤§å­¸\n5.ç¢©åš(200ğŸª™)");
            if(lv >= 1 && lv <= 5) startQuiz(parseInt(lv), 'brush');
        } else {
            if(confirm("ğŸ† é–‹å§‹ç«¶è³½æŒ‘æˆ°ï¼šåƒ…è€—è²» 1 é»é«”åŠ›ï¼Œé«˜é›£åº¦ï¼Œé«˜å›å ±ï¼")) {
                startQuiz(5, 'compete');
            }
        }
    }

    function startQuiz(lv, type) {
        // è¦å‰‡ï¼šç«¶è³½åªæ‰£ 1 é»ï¼Œåˆ·é¡Œæ‰£ 1 é»
        state.stamina -= 1;
        state.quiz = { active: true, current: 1, errors: 0, lv: lv, type: type };
        
        sessionStorage.setItem('isGuilty', 'true'); // æ¨™è¨˜é€²å…¥ç­”é¡Œ
        document.getElementById('quiz-overlay').style.display = 'flex';
        updateUI();
        loadQuestion();
    }

    function loadQuestion() {
        const lvNames = ['', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'ç¢©åš'];
        document.getElementById('quiz-title').innerText = `${lvNames[state.quiz.lv]}é›£åº¦ - ${state.quiz.type==='compete'?'ç«¶è³½é¡Œ':'åˆ·é¡Œæ¨¡å¼'}`;
        document.getElementById('quiz-progress').innerText = `ç¬¬ ${state.quiz.current} / 10 é¡Œ (éŒ¯èª¤ï¼š${state.quiz.errors})`;
        document.getElementById('quiz-text').innerText = state.teacher === 'ling' ? "ã€ç†ç§‘æ ¸å¿ƒã€‘é—œæ–¼äººé«”å…ç–«ç³»çµ±çš„æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ" : "ã€æ–‡ç§‘ç²¾é¸ã€‘é€™æ®µå¤è©©è©çš„ä¿®è¾­æ‰‹æ³•æ˜¯ï¼Ÿ";
        
        const optBox = document.getElementById('quiz-options');
        optBox.innerHTML = '';
        const opts = ["æ­£ç¢ºç­”æ¡ˆå…§å®¹", "éŒ¯èª¤å¹²æ“¾é …å…§å®¹"];
        opts.sort(() => Math.random() - 0.5).forEach(o => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = o;
            b.onclick = () => handleAnswer(o === "æ­£ç¢ºç­”æ¡ˆå…§å®¹");
            optBox.appendChild(b);
        });

        // å¤§å­¸/ç¢©åš/ç«¶è³½ ä¸è¨ˆæ™‚
        const timer = document.getElementById('quiz-timer');
        if(state.quiz.lv >= 4 || state.quiz.type === 'compete') {
            timer.innerText = "âš–ï¸ é«˜éšæŒ‘æˆ°ï¼šä¸è¨ˆæ™‚ (åš´ç¦æŸ¥è³‡æ–™/åˆ‡åˆ†é )";
        } else {
            timer.innerText = "â³ æ€è€ƒæ™‚é–“ï¼š20s";
        }
    }

    function handleAnswer(isCorrect) {
        if(!isCorrect) state.quiz.errors++;
        if(state.quiz.current < 10) {
            state.quiz.current++;
            loadQuestion();
        } else {
            concludeQuiz();
        }
    }

    function concludeQuiz() {
        sessionStorage.setItem('isGuilty', 'false'); // è§£é™¤ä½œå¼Šç›£æ§
        const errorRate = state.quiz.errors / 10;
        let reward = 0;

        if(errorRate > 0.3) {
            alert(`æ±Ÿè€å¸«ï¼šå¾ˆéºæ†¾ï¼Œå¦³éŒ¯äº† ${state.quiz.errors} é¡Œï¼ŒéŒ¯èª¤ç‡è¶…é 30%ã€‚é«”åŠ›ç…§æ‰£ï¼Œä½†é€™æ¬¡æ²’æœ‰çå‹µå–”ã€‚`);
        } else {
            // çå‹µéå¢ 50-200
            reward = (state.quiz.lv * 37.5) + 12.5;
            if(state.quiz.type === 'compete') reward = 500; // ç«¶è³½ç‰¹æ®Šå¤§ç
            
            if(state.isAdmin) reward *= 10;
            state.coins += Math.round(reward);
            alert(`ğŸ‰ å¤ªæ£’äº†ï¼å¦³é€šéäº†æŒ‘æˆ°ï¼Œç²å¾—é‡‘å¹£ ğŸª™${Math.round(reward)}ï¼`);
        }

        state.quiz.active = false;
        document.getElementById('quiz-overlay').style.display = 'none';
        updateUI();
        saveToLocal();
    }

    // ç³»çµ±è¼”åŠ©
    function createSnow() {
        const s = document.createElement('div');
        s.className = 'snowflake'; s.innerText = 'â„ï¸';
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = (Math.random() * 3 + 4) + 's';
        s.onclick = () => {
            if(prompt("æ±Ÿå®¶ç®¡ç†è€…å¯†é‘°ï¼š") === "æ±Ÿæ†¶å©·") {
                state.isAdmin = true; state.coins += 1000; updateUI();
                alert("ğŸ‘‘ æ­¡è¿ç®¡ç†è€…æ±Ÿæ†¶å©·ï¼1000å…ƒå•Ÿå‹•é‡‘å·²ç™¼æ”¾ï¼Œå•†å ´èˆ‡ç­”é¡Œé‡‘å¹£åŠ æˆå·²å•Ÿå‹•ã€‚");
            }
        };
        document.getElementById('snow-container').appendChild(s);
        setTimeout(() => s.remove(), 7000);
    }

    function refillStamina() {
        state.stamina = 10; updateUI(); saveToLocal();
        alert("æ±Ÿéˆ´ï¼šé«”åŠ›å·²ç¶“å……èƒ½å®Œç•¢ï¼");
    }

    function updateUI() {
        document.getElementById('coin-val').innerText = state.coins;
        document.getElementById('sta-val').innerText = state.stamina;
    }

    function saveToLocal() {
        localStorage.setItem('savedSta', state.stamina);
        localStorage.setItem('coin', state.coins);
    }

    function toggleChat(show) { document.getElementById('chat-window').style.display = show ? 'flex' : 'none'; }

</script>
</body>
</html><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚ - çµ‚æ¥µç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --gold: #d4af37; --white: rgba(255,255,255,0.95); --error: #ff4757; }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; transition: 0.3s ease; }
        body { margin: 0; background: #1a1a1a; color: #333; height: 100vh; overflow: hidden; }

        #world-bg { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.3)), url('æ±Ÿè€å¸«åˆç…§.jpg'); background-size: cover; background-position: center; z-index: -1; }
        
        /* é›ªèŠ±ç³»çµ± */
        .snowflake { position: fixed; top: -10%; color: white; cursor: pointer; z-index: 1000; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* å°èˆª */
        #sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 200px; background: var(--white); display: flex; flex-direction: column; padding-top: 40px; z-index: 100; box-shadow: 2px 0 20px rgba(0,0,0,0.2); }
        .nav-link { padding: 18px 25px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #eee; text-decoration: none; color: var(--main); }
        .nav-link:hover { background: var(--main); color: white; }

        /* ç‹€æ…‹æ¬„ */
        .status-bar { position: fixed; top: 20px; right: 30px; display: flex; gap: 15px; z-index: 100; }
        .stat-box { background: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; }

        /* AI ç¾¤èŠè¦–çª— */
        #chat-window { position: fixed; bottom: 20px; right: 20px; width: 380px; height: 550px; background: #f0f2f5; border-radius: 25px; display: none; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); z-index: 500; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .chat-header { background: var(--main); color: white; padding: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg.teacher { background: white; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #2c3e50; }
        .msg.user { background: var(--main); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ctrl { padding: 15px; background: white; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { display: flex; gap: 8px; }
        input#user-text { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none; }

        /* ç­”é¡Œé®ç½© */
        #quiz-overlay { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .btn-opt { padding: 15px 40px; margin: 10px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #eee; background: white; cursor: pointer; width: 320px; font-weight: bold; }
        .btn-opt:hover { border-color: var(--gold); background: #fffcf0; }
        
        /* ç®¡ç†è€…æ¨¡å¼ UI */
        .admin-glow { box-shadow: 0 0 15px var(--gold) !important; border: 2px solid var(--gold) !important; }
    </style>
</head>
<body onload="init()">

<div id="world-bg"></div>
<div id="snow-container"></div>

<div id="sidebar">
    <div style="text-align:center; padding:20px; font-weight:900; color:var(--gold); font-size:1.2rem; letter-spacing: 2px;">æ±Ÿå®¶æ™ºæ…§åŸå¸‚</div>
    <div class="nav-link" onclick="openChat('ling')">ğŸ‘©â€âš•ï¸ æ±Ÿéˆ´è€å¸« (ç†ç§‘)</div>
    <div class="nav-link" onclick="openChat('yi')">ğŸ¨ æ±Ÿä¾è€å¸« (æ–‡ç§‘)</div>
    <div class="nav-link" onclick="enterYard()">ğŸ¡ æ±Ÿå®¶åº­é™¢</div>
    <div class="nav-link" onclick="openAlbum()">ğŸ–¼ï¸ æ±Ÿè€å¸«ç›¸ç°¿</div>
    <div class="nav-link" onclick="openShop()">ğŸ›’ åŸå¸‚å•†å ´</div>
</div>

<div class="status-bar">
    <div class="stat-box" onclick="refillStamina()" style="cursor:pointer;" title="é»æ“Šè£œå……é«”åŠ›">âš¡ <span id="sta">10</span></div>
    <div class="stat-box">ğŸª™ <span id="coin">500</span></div>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span id="chat-name">æ±Ÿè€å¸«ç¾¤èŠ</span>
        <span onclick="document.getElementById('chat-window').style.display='none'" style="cursor:pointer;">âœ•</span>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-ctrl">
        <div class="chat-input-area">
            <input type="text" id="user-text" placeholder="è·Ÿè€å¸«èŠèŠå¤©..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" style="border:none; background:var(--gold); color:white; border-radius:10px; padding:0 15px; cursor:pointer;">ç™¼é€</button>
        </div>
        <div style="display:flex; gap:5px;">
            <button onclick="prepareQuiz('brush')" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; background:#f8f9fa; cursor:pointer; font-weight:bold;">æˆ‘è¦åˆ·é¡Œ</button>
            <button onclick="prepareQuiz('compete')" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--gold); background:white; cursor:pointer; font-weight:bold; color:var(--gold);">æˆ‘æƒ³æŒ‘æˆ°ç«¶è³½</button>
        </div>
    </div>
</div>

<div id="quiz-overlay">
    <h2 id="q-lv-title" style="color:var(--main);">é›£åº¦åŠ è¼‰ä¸­</h2>
    <div id="q-progress" style="margin-bottom:20px; color:var(--gold); font-weight:bold; font-size:1.2rem;">ç¬¬ 1 / 10 é¡Œ</div>
    <p id="q-content" style="font-size:1.5rem; padding:0 10%; text-align:center; line-height:1.6; min-height:100px;"></p>
    <div id="q-options"></div>
    <div id="q-timer" style="margin-top:30px; font-weight:bold; color:var(--error);"></div>
    <p style="color:#999; margin-top:20px; font-size:0.8rem;">âš ï¸ åš´ç¦åˆ‡æ›åˆ†é æˆ–é‡æ–°æ•´ç†ï¼Œé•è€…æ‰£é™¤é«”åŠ›ä¸¦å–æ¶ˆè³‡æ ¼ã€‚</p>
</div>

<script>
    // æ ¸å¿ƒæ•¸æ“š
    let state = {
        coins: 500, stamina: 10, teacher: '', isAdmin: false,
        quiz: { active: false, current: 0, errors: 0, lv: 1, type: '', reward: 0 }
    };

    const teacherData = {
        ling: { name: 'æ±Ÿéˆ´', intro: 'æº–å‚™å¥½é€²å…¥ç†æ€§çš„é†«å­¸ä¸–ç•Œäº†å—ï¼Ÿ' },
        yi: { name: 'æ±Ÿä¾', intro: 'è®“æˆ‘å€‘åœ¨æ–‡å­¸èˆ‡è—è¡“ä¸­æ¼«æ­¥å§ã€‚' }
    };

    // åˆå§‹åŒ–
    function init() {
        // åä½œå¼Šåµæ¸¬ï¼šè‹¥ session ä¸­æœ‰æœªå®Œæˆçš„ç­”é¡Œæ¨™è¨˜
        if (sessionStorage.getItem('inQuiz') === 'true') {
            let s = parseInt(localStorage.getItem('sta') || 10);
            state.stamina = Math.max(0, s - 2);
            alert("âš ï¸ ç³»çµ±åµæ¸¬åˆ°æ‚¨åœ¨ç­”é¡Œä¸­é€”éæ³•é‡æ•´é é¢ï¼å·²æ‰£é™¤ 2 é»é«”åŠ›ä½œç‚ºè™•ç½°ã€‚");
            saveState();
        } else {
            state.stamina = parseInt(localStorage.getItem('sta')) || 10;
            state.coins = parseInt(localStorage.getItem('coin')) || 500;
        }

        updateUI();
        setInterval(createSnow, 400);

        // ç¦æ­¢åˆ‡æ›åˆ†é åµæ¸¬
        window.onblur = () => {
            if(state.quiz.active) {
                alert("æ±Ÿè€å¸«ï¼šç­”é¡Œæ™‚è«‹ä¿æŒå°ˆæ³¨ï¼åµæ¸¬åˆ°é›¢é–‹é é¢ï¼Œæœ¬æ¬¡æŒ‘æˆ°ç„¡æ•ˆã€‚");
            }
        };
    }

    // AI ç¾¤èŠåŠŸèƒ½
    function openChat(t) {
        state.teacher = t;
        const win = document.getElementById('chat-window');
        win.style.display = 'flex';
        document.getElementById('chat-name').innerText = `èˆ‡ ${teacherData[t].name} è€å¸«å°è©±`;
        addMsg('teacher', `å“ˆå›‰ï¼æˆ‘æ˜¯${teacherData[t].name}è€å¸«ã€‚${teacherData[t].intro}`);
    }

    function sendChat() {
        const input = document.getElementById('user-text');
        if(!input.value.trim()) return;
        addMsg('user', input.value);
        
        // æ¨¡æ“¬ AI å›è¦†
        const responses = [
            "é€™æ˜¯ä¸€å€‹å¾ˆæœ‰è¶£çš„è§€é»ï¼Œå¦³ç¸½æ˜¯èƒ½å¾ä¸åŒè§’åº¦çœ‹å•é¡Œã€‚",
            "æˆ‘æ˜ç™½äº†ï¼Œé€™ç¢ºå¯¦å€¼å¾—æˆ‘å€‘æ·±å…¥æ¢è¨ã€‚",
            "ç„¡è«–é‡åˆ°ä»€éº¼å›°é›£ï¼Œæ±Ÿè€å¸«éƒ½æœƒé™ªå¦³ä¸€èµ·é¢å°çš„ã€‚",
            "ä»Šå¤©çš„å¿ƒæƒ…ä¸éŒ¯å§ï¼Ÿè¦ä¸è¦è·Ÿæˆ‘åˆ†äº«æ›´å¤šï¼Ÿ",
            "é€™è®“æˆ‘æƒ³èµ·äº†ä¸€å€‹éå¸¸æœ‰æ„ç¾©çš„æ•…äº‹..."
        ];
        setTimeout(() => addMsg('teacher', responses[Math.floor(Math.random()*responses.length)]), 800);
        input.value = '';
    }

    function addMsg(role, text) {
        const box = document.getElementById('chat-msgs');
        box.innerHTML += `<div class="msg ${role}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // ç­”é¡Œç³»çµ±é‚è¼¯
    function prepareQuiz(mode) {
        if(state.stamina <= 0) return addMsg('teacher', "é«”åŠ›ä¸è¶³å–”ï¼é»æ“Šå³ä¸Šæ–¹é›»æ± ä¼‘æ¯ä¸€ä¸‹å§ã€‚");
        
        if(mode === 'brush') {
            const lv = prompt("é¸æ“‡é›£åº¦ (1:åœ‹å° 2:åœ‹ä¸­ 3:é«˜ä¸­ 4:å¤§å­¸ 5:ç¢©åš)");
            if(lv >= 1 && lv <= 5) {
                startQuiz(parseInt(lv), 'brush');
            }
        } else {
            // ç«¶è³½æ¨¡å¼
            if(confirm("ç¢ºå®šè¦é–‹å§‹ç«¶è³½æŒ‘æˆ°å—ï¼Ÿç«¶è³½é¡Œé›£åº¦é«˜ä½†åªéœ€è€—è²» 1 é»é«”åŠ›ï¼")) {
                startQuiz(5, 'compete');
            }
        }
    }

    function startQuiz(lv, type) {
        // ç«¶è³½åªæ‰£1é»ï¼Œä¸€èˆ¬åˆ·é¡Œæ‰£2é»(æˆ–è‡ªå®šç¾©)
        const cost = (type === 'compete') ? 1 : 1; 
        state.stamina -= cost;
        state.quiz = { active: true, current: 1, errors: 0, lv: lv, type: type };
        
        sessionStorage.setItem('inQuiz', 'true');
        document.getElementById('quiz-overlay').style.display = 'flex';
        updateUI();
        loadQuestion();
    }

    function loadQuestion() {
        const lvNames = ['', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'ç¢©åš'];
        document.getElementById('q-lv-title').innerText = `${lvNames[state.quiz.lv]}é›£åº¦ - ${state.quiz.type === 'compete' ? 'ğŸ† ç«¶è³½æ¨¡å¼' : 'ğŸ“– æ—¥å¸¸åˆ·é¡Œ'}`;
        document.getElementById('q-progress').innerText = `ç¬¬ ${state.quiz.current} / 10 é¡Œ`;
        
        // æ¨¡æ“¬é¡Œç›®
        const qContent = state.teacher === 'ling' ? "ã€ç†ç§‘é¡Œã€‘é—œæ–¼ç´°èƒèƒ½é‡å·¥å» çš„æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ" : "ã€æ–‡ç§‘é¡Œã€‘é€™å¥å¤è©©çš„ä½œè€…æ˜¯èª°ï¼Ÿ";
        document.getElementById('q-content').innerText = qContent;
        
        const box = document.getElementById('q-options');
        box.innerHTML = '';
        const options = ["é€™æ˜¯æ­£ç¢ºé¸é …", "é€™æ˜¯å¹²æ“¾é¸é …"];
        options.sort(() => Math.random() - 0.5).forEach(opt => {
            const b = document.createElement('button');
            b.className = 'btn-opt';
            b.innerText = opt;
            b.onclick = () => handleAnswer(opt === "é€™æ˜¯æ­£ç¢ºé¸é …");
            box.appendChild(b);
        });

        // é›£åº¦è¨ˆæ™‚
        const timerBox = document.getElementById('q-timer');
        if(state.quiz.lv >= 4 || state.quiz.type === 'compete') {
            timerBox.innerText = "âš–ï¸ é«˜éšæŒ‘æˆ°ï¼šä¸è¨ˆæ™‚ï¼Œè«‹æ·±æ€ç†Ÿæ…®ã€‚";
        } else {
            timerBox.innerText = "â³ æ€è€ƒæ™‚é–“ï¼š20 ç§’";
        }
    }

    function handleAnswer(isRight) {
        if(!isRight) state.quiz.errors++;
        
        if(state.quiz.current < 10) {
            state.quiz.current++;
            loadQuestion();
        } else {
            concludeQuiz();
        }
    }

    function concludeQuiz() {
        sessionStorage.setItem('inQuiz', 'false');
        const errorRate = state.quiz.errors / 10;
        let reward = 0;

        if(errorRate > 0.3) {
            alert(`æ±Ÿè€å¸«ï¼šé€™å¥—é¡Œå¦³éŒ¯äº† ${state.quiz.errors} é¡Œï¼ŒéŒ¯èª¤ç‡è¶…é 30%ï¼Œæœ¬æ¬¡ç„¡æ³•ç²å¾—çå‹µ... é«”åŠ›å·²è€—è²»ï¼Œè¦å†åŠ æ²¹å–”ï¼`);
        } else {
            // çå‹µéå¢ 50 -> 200
            reward = (state.quiz.lv * 37.5) + 12.5; 
            if(state.quiz.type === 'compete') reward = 500; // ç«¶è³½é«˜é¡çå‹µ
            
            if(state.isAdmin) reward *= 10;
            state.coins += Math.round(reward);
            alert(`ğŸ‰ æ­å–œå®Œæˆï¼ç­”å° ${10 - state.quiz.errors} é¡Œï¼Œç²å¾—é‡‘å¹£ ğŸª™${Math.round(reward)}ï¼`);
        }

        state.quiz.active = false;
        document.getElementById('quiz-overlay').style.display = 'none';
        updateUI();
        saveState();
    }

    // ç³»çµ±åŠŸèƒ½
    function createSnow() {
        const s = document.createElement('div');
        s.className = 'snowflake'; s.innerText = 'â„ï¸';
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = (Math.random() * 3 + 4) + 's';
        s.onclick = () => {
            const code = prompt("ç™¼ç¾éš±è—é›ªèŠ±ï¼è«‹è¼¸å…¥ç®¡ç†è€…é©—è­‰ç¢¼ï¼š");
            if(code === "æ±Ÿæ†¶å©·") {
                state.isAdmin = true;
                state.coins += 1000;
                document.querySelector('.status-bar').classList.add('admin-glow');
                updateUI();
                alert("ğŸ‘‘ æ­¡è¿ç®¡ç†è€…æ±Ÿæ†¶å©·ï¼1000å…ƒå·²æ’¥ä»˜ï¼Œå•†å ´1æŠ˜ç‰¹æ¬Šèˆ‡ç„¡é™é‡‘å¹£åŠ æˆå·²å•Ÿå‹•ã€‚");
            }
        };
        document.getElementById('snow-container').appendChild(s);
        setTimeout(() => s.remove(), 7000);
    }

    function updateUI() {
        document.getElementById('coin').innerText = state.coins;
        document.getElementById('sta').innerText = state.stamina;
    }

    function refillStamina() {
        state.stamina = 10;
        updateUI();
        saveState();
        alert("æ±Ÿéˆ´ï¼šä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ï¼Œé«”åŠ›å·²è£œå……å®Œç•¢ï¼");
    }

    function saveState() {
        localStorage.setItem('sta', state.stamina);
        localStorage.setItem('coin', state.coins);
    }

    function enterYard() { alert("é€²å…¥æ±Ÿå®¶åº­é™¢ä¸­... é™½å…‰ç‘åœ¨è‰åœ°ä¸ŠçœŸç¾ï¼"); }
    function openAlbum() { alert("æ‰“é–‹ç›¸ç°¿ä¸­... æ»¿æ»¿éƒ½æ˜¯è€å¸«å€‘çš„å›æ†¶ã€‚"); }
    function openShop() { alert(state.isAdmin ? "ç®¡ç†è€…å°Šæ¦®å•†å ´é–‹å•Ÿï¼šå…¨å ´ 1 æŠ˜ï¼" : "é€²å…¥å•†å ´ä¸­..."); }

</script>
</body>
</html>
