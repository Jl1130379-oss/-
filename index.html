<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚ - ç•«é¢¨æ•´åˆç‰ˆ</title>
    <style>
        /* æ ¸å¿ƒè¨­è¨ˆè®Šæ•¸ */
        :root {
            --main-color: #5a7d9b; /* åƒè€ƒæ±Ÿè€å¸«ç•«é¢¨çš„è—ç°è‰²èª¿ */
            --accent-color: #e6b8a2; /* åƒè€ƒç•«é¢¨ä¸­çš„æš–è‰²èª¿ */
            --text-color: #333d47;
            --bg-light: #f5f9fc; /* æ·ºèƒŒæ™¯ */
            --bg-dark: #3a475a;  /* æ·±èƒŒæ™¯ */
            --border-light: rgba(255, 255, 255, 0.5);
            --border-dark: rgba(0, 0, 0, 0.1);
            --font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* å…¨å±€è¨­å®š */
        * { box-sizing: border-box; font-family: var(--font-family); transition: all 0.3s ease-in-out; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; }

        /* èƒŒæ™¯ï¼šä½¿ç”¨å¦³çš„åœ–ç‰‡ 'IMG_7210.jpg' */
        #world-bg {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('IMG_7210.jpg'); /* ä½¿ç”¨å¦³æä¾›çš„åœ–ç‰‡ */
            background-size: cover; background-position: center;
            z-index: -2; /* ç¢ºä¿åœ¨é›ªèŠ±ä¸‹æ–¹ */
        }
        /* å¦‚æœåœ–ç‰‡ä»ç„¡æ³•è¼‰å…¥ï¼Œæä¾›ä¸€å€‹å„ªé›…çš„é™ç´šæ–¹æ¡ˆ */
        #world-bg:not([style*="background-image"]) {
            background: linear-gradient(135deg, #4a6a8c 0%, #2e455e 100%);
        }

        /* é›ªèŠ±ç³»çµ± - èˆ‡ç•«é¢¨èåˆ */
        .snowflake {
            position: fixed; top: -10%; color: var(--border-light); cursor: pointer;
            user-select: none; z-index: 1000; pointer-events: auto;
            animation: fall linear infinite; text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* å·¦å´å°èˆª - ç•«é¢¨æ•´åˆ */
        #sidebar {
            width: 250px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 30px 0; box-shadow: var(--shadow-dark); z-index: 100;
            display: flex; flex-direction: column; border-right: 1px solid var(--border-dark);
        }
        .sidebar-header {
            text-align: center; color: var(--main-color); font-size: 1.8rem;
            font-weight: 800; margin-bottom: 40px; letter-spacing: 1px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .nav-link {
            padding: 18px 25px; cursor: pointer; font-weight: 600; font-size: 1.1rem;
            color: var(--text-color); border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 15px; text-decoration: none;
        }
        .nav-link:hover { background: var(--main-color); color: white; padding-left: 35px; }
        .nav-link i { font-size: 1.3rem; } /* FontAwesome icons */

        /* ä¸»å…§å®¹å€åŸŸ */
        #main-content { flex: 1; position: relative; }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ - ç•«é¢¨æ•´åˆ */
        .status-bar {
            position: absolute; top: 25px; right: 30px; display: flex; gap: 18px; z-index: 10;
        }
        .stat-box {
            background: rgba(255, 255, 255, 0.95); padding: 12px 25px; border-radius: 50px;
            font-weight: 700; font-size: 1.1rem; color: var(--text-color);
            box-shadow: var(--shadow-light); display: flex; align-items: center; gap: 8px;
            cursor: pointer; border: 1px solid var(--border-dark);
        }
        .stat-box:hover { background: white; transform: translateY(-2px); }

        /* AI ç¾¤èŠè¦–çª— - ç•«é¢¨æ•´åˆ */
        #chat-window {
            position: fixed; bottom: 30px; right: 30px; width: 420px; height: 620px;
            background: rgba(255, 255, 255, 0.95); border-radius: 25px; display: none;
            flex-direction: column; box-shadow: var(--shadow-dark); z-index: 200;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .chat-header {
            background: var(--main-color); color: white; padding: 22px; border-top-left-radius: 25px;
            border-top-right-radius: 25px; font-weight: 700; font-size: 1.3rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header span.close-btn { font-size: 1.8rem; cursor: pointer; opacity: 0.8; }
        .chat-header span.close-btn:hover { opacity: 1; transform: rotate(90deg); }

        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 80%; font-size: 0.98rem; line-height: 1.5; }
        .msg.teacher {
            background: var(--bg-light); align-self: flex-start; border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); color: var(--text-color);
            border: 1px solid var(--border-dark);
        }
        .msg.user {
            background: var(--accent-color); color: white; align-self: flex-end;
            border-bottom-right-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .chat-input-area { padding: 20px; background: white; border-top: 1px solid #eee; }
        .chat-input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        input#user-input {
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border-dark);
            outline: none; font-size: 1rem;
        }
        .send-btn {
            background: var(--main-color); color: white; border: none; border-radius: 10px;
            padding: 0 20px; cursor: pointer; font-size: 1.1rem; font-weight: 600;
        }
        .chat-actions { display: flex; gap: 8px; }
        .chat-actions button {
            flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--accent-color);
            background: white; color: var(--accent-color); font-weight: bold; cursor: pointer;
            font-size: 0.95rem;
        }
        .chat-actions button:hover { background: var(--accent-color); color: white; }


        /* ç­”é¡Œç³»çµ±é®ç½© - ç•«é¢¨æ•´åˆ */
        #quiz-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .quiz-card {
            background: white; padding: 40px; border-radius: 20px; width: 70%; max-width: 800px;
            box-shadow: var(--shadow-dark); text-align: center;
            border: 2px solid var(--main-color);
        }
        #quiz-title-text { color: var(--main-color); font-size: 2.5rem; margin-bottom: 15px; }
        #quiz-progress-text { color: var(--accent-color); font-size: 1.3rem; margin-bottom: 25px; }
        #quiz-question-text { font-size: 1.8rem; line-height: 1.7; margin-bottom: 40px; color: var(--text-color); }
        .quiz-options-container { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 400px; }
        .option-button {
            padding: 18px 30px; border-radius: 12px; border: 2px solid var(--border-dark);
            background: var(--bg-light); color: var(--text-color); font-size: 1.2rem;
            cursor: pointer; font-weight: 600;
        }
        .option-button:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        #quiz-timer-text { margin-top: 35px; font-weight: 900; color: var(--err); font-size: 1.8rem; }
        .quiz-warning { color: #888; margin-top: 15px; font-size: 0.9rem; }

        /* ç›¸ç°¿ modal - ç•«é¢¨æ•´åˆ */
        #album-modal, #shop-modal, #closet-modal, #yard-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1500;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content-area {
            background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px;
            box-shadow: var(--shadow-dark); width: 80%; max-width: 900px;
            text-align: center; border: 2px solid var(--main-color);
            position: relative;
        }
        .modal-title { color: var(--main-color); font-size: 2.2rem; margin-bottom: 30px; font-weight: 700; }
        .modal-close-btn {
            position: absolute; top: 20px; right: 25px; font-size: 2.5rem;
            color: var(--text-color); cursor: pointer; opacity: 0.7;
        }
        .modal-close-btn:hover { opacity: 1; transform: scale(1.1); }

        #album-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            margin-top: 20px; max-height: 500px; overflow-y: auto;
        }
        .album-photo {
            width: 100%; aspect-ratio: 16/9; background: var(--bg-light);
            border: 2px solid var(--border-dark); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-color); font-size: 0.9rem; overflow: hidden;
            box-shadow: var(--shadow-light);
        }
        .album-photo img { width: 100%; height: 100%; object-fit: cover; }
        .album-empty { color: #888; font-style: italic; grid-column: span 3; }

        /* å•†å ´/æ›´è¡£å®¤ */
        .shop-item-card, .closet-item-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 25px; border: 1px solid var(--border-dark); border-radius: 15px;
            box-shadow: var(--shadow-light); background: var(--bg-light); margin-bottom: 20px;
        }
        .shop-item-card img, .closet-item-card img {
            width: 150px; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        .item-name { font-size: 1.4rem; font-weight: 600; color: var(--main-color); margin-bottom: 10px; }
        .item-price { font-size: 1.1rem; color: var(--accent-color); margin-bottom: 15px; }
        .buy-btn {
            padding: 10px 25px; background: var(--accent-color); color: white;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .buy-btn:hover { background: var(--main-color); }

        /* åº­é™¢ */
        #yard-content {
            background-image: url('yard_background.jpg'); /* åº­é™¢èƒŒæ™¯åœ– */
            background-size: cover; background-position: center;
            position: absolute; inset: 0; display: flex; align-items: flex-end; justify-content: center;
        }
        #snap-button {
            background: rgba(255,255,255,0.9); border: 3px solid var(--accent-color);
            border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center;
            justify-content: center; font-size: 2.5rem; color: var(--main-color);
            box-shadow: var(--shadow-dark); cursor: pointer; margin-bottom: 40px;
        }
        #snap-button:hover { transform: scale(1.1); background: white; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body onload="initSystem()">

<div id="world-bg"></div>
<div id="snow-container"></div>

<div id="sidebar">
    <div class="sidebar-header">æ±Ÿå®¶æ™ºæ…§åŸå¸‚</div>
    <div class="nav-link" onclick="openChat('ling')"><i class="fas fa-flask"></i> ç†ç§‘æ•™ç ” (æ±Ÿéˆ´)</div>
    <div class="nav-link" onclick="openChat('yi')"><i class="fas fa-book-open"></i> æ–‡ç§‘å“é‘‘ (æ±Ÿä¾)</div>
    <div class="nav-link" onclick="openYard()"><i class="fas fa-leaf"></i> æ±Ÿå®¶åº­é™¢</div>
    <div class="nav-link" onclick="openAlbum()"><i class="fas fa-images"></i> æ±Ÿè€å¸«ç›¸ç°¿</div>
    <div class="nav-link" onclick="openShop()"><i class="fas fa-store"></i> åŸå¸‚å•†å ´</div>
    <div class="nav-link" onclick="openCloset()"><i class="fas fa-tshirt"></i> ç§äººæ›´è¡£å®¤</div>
</div>

<div id="main-content">
    <div class="status-bar">
        <div class="stat-box" onclick="refillStamina()" title="é»æ“Šè£œå……é«”åŠ›">âš¡ <span id="sta-val">10</span></div>
        <div class="stat-box">ğŸª™ <span id="coin-val">500</span></div>
    </div>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span id="chat-title">æ±Ÿè€å¸«ç¾¤èŠ</span>
        <span class="close-btn" onclick="toggleChat(false)"><i class="fas fa-times"></i></span>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-input-area">
        <div class="input-row">
            <input type="text" id="user-input" placeholder="æƒ³è·Ÿè€å¸«èªªä»€éº¼..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="send-btn" onclick="sendMessage()">ç™¼é€</button>
        </div>
        <div class="action-row">
            <button onclick="triggerAction('brush')">æˆ‘è¦åˆ·é¡Œ</button>
            <button onclick="triggerAction('compete')">æˆ‘æƒ³æŒ‘æˆ°ç«¶è³½</button>
        </div>
    </div>
</div>

<div id="quiz-overlay">
    <div class="quiz-card">
        <h2 id="quiz-title-text">é›£åº¦ï¼šåœ‹å°</h2>
        <div id="quiz-progress-text">1 / 10 é¡Œ</div>
        <p id="quiz-question-text"></p>
        <div id="quiz-options" class="quiz-options-container"></div>
        <div id="quiz-timer-text"></div>
        <p class="quiz-warning">ä½œå¼Šåµæ¸¬ï¼šç¦æ­¢é‡æ•´é é¢æˆ–åˆ‡æ›æ¨™ç±¤é ã€‚</p>
    </div>
</div>

<div id="album-modal">
    <div class="modal-content-area">
        <span class="modal-close-btn" onclick="closeModal('album')"><i class="fas fa-times"></i></span>
        <h2 class="modal-title"><i class="fas fa-images"></i> æ±Ÿè€å¸«ç›¸ç°¿</h2>
        <div id="album-grid">
            <p class="album-empty">ç›¸ç°¿ç©ºç©ºçš„ï¼Œå¿«å»åº­é™¢æ‹ç…§å§ï¼</p>
        </div>
    </div>
</div>

<div id="shop-modal">
    <div class="modal-content-area">
        <span class="modal-close-btn" onclick="closeModal('shop')"><i class="fas fa-times"></i></span>
        <h2 class="modal-title"><i class="fas fa-store"></i> åŸå¸‚å•†å ´</h2>
        <div id="shop-items-container">
            <div class="shop-item-card">
                <img src="shop_item_fountain.jpg" alt="å™´æ³‰">
                <div class="item-name">å¤§ç†çŸ³å™´æ³‰</div>
                <div class="item-price">ğŸª™ <span id="fountain-price">1000</span></div>
                <button class="buy-btn" onclick="buyItem('fountain')">è³¼è²·</button>
            </div>
            </div>
    </div>
</div>

<div id="closet-modal">
    <div class="modal-content-area">
        <span class="modal-close-btn" onclick="closeModal('closet')"><i class="fas fa-times"></i></span>
        <h2 class="modal-title"><i class="fas fa-tshirt"></i> ç§äººæ›´è¡£å®¤</h2>
        <div id="closet-items-container">
            <div class="closet-item-card">
                <img src="closet_item_dress.jpg" alt="é•·è£™">
                <div class="item-name">å„ªé›…é•·è£™</div>
                <div class="item-price">ğŸª™ <span id="dress-price">800</span></div>
                <button class="buy-btn" onclick="buyItem('dress')">æ›è£</button>
            </div>
            </div>
    </div>
</div>

<div id="yard-modal">
    <div id="yard-content">
        <button id="snap-button" onclick="capturePhoto()"><i class="fas fa-camera"></i></button>
    </div>
</div>


<script>
    let state = {
        coins: 500, stamina: 10, teacher: '', isAdmin: false,
        quiz: { active: false, current: 0, errors: 0, lv: 1, type: '', timerInterval: null },
        photos: [] // å„²å­˜ç›¸ç°¿åœ–ç‰‡çš„é™£åˆ—
    };

    const teacherProfiles = {
        ling: { name: "æ±Ÿéˆ´", greet: "ä½ å¥½ï¼Œæˆ‘æ˜¯æ±Ÿéˆ´ã€‚é†«å­¸çš„åš´è¬¹éœ€è¦å†·éœçš„é ­è…¦ï¼Œå¦³æº–å‚™å¥½äº†å—ï¼Ÿ" },
        yi: { name: "æ±Ÿä¾", greet: "å“ˆå›‰ï¼æˆ‘æ˜¯æ±Ÿä¾ã€‚è®“æˆ‘å€‘åœ¨æ–‡å­—èˆ‡è—è¡“çš„æµ·æ´‹è£¡æ‰¾åˆ°å¯§éœå§ã€‚" }
    };

    // --- ç³»çµ±åˆå§‹åŒ– ---
    function initSystem() {
        // å¾ localStorage è¼‰å…¥æ•¸æ“šï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼
        state.stamina = parseInt(localStorage.getItem('savedSta')) || 10;
        state.coins = parseInt(localStorage.getItem('savedCoin')) || 500;
        state.photos = JSON.parse(localStorage.getItem('savedPhotos')) || [];
        state.isAdmin = localStorage.getItem('isAdmin') === 'true';

        // é˜²é‡æ•´ä½œå¼Šåµæ¸¬
        if (sessionStorage.getItem('isGuilty') === 'true') {
            state.stamina = Math.max(0, state.stamina - 2);
            alert("ğŸš¨ ç³»çµ±åµæ¸¬åˆ°æ‚¨åœ¨æŒ‘æˆ°ä¸­éæ³•é‡æ•´ï¼å·²æ‰£é™¤ 2 é»é«”åŠ›ä½œç‚ºè™•ç½°ã€‚");
            sessionStorage.removeItem('isGuilty'); // æ¸…é™¤æ¨™è¨˜
            saveState(); // æ›´æ–°æ•¸æ“š
        }
        
        updateUI();
        setInterval(createSnow, 400);

        // é˜²åˆ‡é åµæ¸¬ (åƒ…è¨˜éŒ„ï¼Œä¸ç«‹å³è™•ç½°ï¼Œæœ€çµ‚çµç®—æ™‚å¯èƒ½ç´å…¥è€ƒé‡)
        window.onblur = () => { if(state.quiz.active) console.warn("åµæ¸¬åˆ°é é¢å¤±å»ç„¦é»ï¼"); };
        window.onfocus = () => { if(state.quiz.active) console.log("é é¢é‡æ–°ç²å¾—ç„¦é»ã€‚"); };
    }

    // --- é›ªèŠ±ç³»çµ± (ç®¡ç†è€…å…¥å£) ---
    function createSnow() {
        const s = document.createElement('div');
        s.className = 'snowflake'; s.innerText = 'â„ï¸';
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = (Math.random() * 3 + 4) + 's';
        s.style.fontSize = (Math.random() * 15 + 10) + 'px'; // é›ªèŠ±å¤§å°éš¨æ©Ÿ
        s.onclick = () => {
            const code = prompt("ç™¼ç¾éš±è—é›ªèŠ±ï¼è«‹è¼¸å…¥ç®¡ç†è€…å¯†é‘°ï¼š");
            if(code === "æ±Ÿæ†¶å©·") {
                state.isAdmin = true; state.coins += 1000;
                document.querySelector('.status-bar').classList.add('admin-glow'); // ç®¡ç†è€…å…‰æšˆæ•ˆæœ
                updateUI(); saveState();
                alert("ğŸ‘‘ æ­¡è¿ç®¡ç†è€…æ±Ÿæ†¶å©·ï¼1000å…ƒå•Ÿå‹•é‡‘å·²ç™¼æ”¾ï¼Œå•†å ´èˆ‡ç­”é¡Œé‡‘å¹£åŠ æˆå·²å•Ÿå‹•ã€‚");
            }
        };
        document.getElementById('snow-container').appendChild(s);
        setTimeout(() => s.remove(), 7000);
    }

    // --- AI ç¾¤èŠèˆ‡éš¨æ„èŠ ---
    function toggleChat(show) { document.getElementById('chat-window').style.display = show ? 'flex' : 'none'; }

    function sendMessage() {
        const input = document.getElementById('user-input');
        if(!input.value.trim()) return;
        addChatMsg('user', input.value);
        
        const responses = [
            "æˆ‘ä¹Ÿåœ¨æƒ³é€™ä»¶äº‹å‘¢ï¼Œçœ‹ä¾†æˆ‘å€‘å¾ˆæœ‰é»˜å¥‘ã€‚",
            "å¦³ä»Šå¤©çœ‹èµ·ä¾†ç‰¹åˆ¥æœ‰ç²¾ç¥ï¼Œæ˜¯å› ç‚ºå­¸ç¿’æœ‰é€²æ­¥å—ï¼Ÿ",
            "é€™å°±æ˜¯æ±Ÿå®¶ç²¾ç¥ï¼Œç„¡è«–å¦‚ä½•ï¼Œæ±Ÿè€å¸«éƒ½æœƒé™ªè‘—å¦³ã€‚",
            "é›–ç„¶æœ‰é›£åº¦ï¼Œä½†æˆ‘ç›¸ä¿¡å¦³çš„æ½›åŠ›ã€‚",
            "å—¯ï¼Œè½èµ·ä¾†å¾ˆä¸éŒ¯ï¼å¦³æ‰“ç®—æ€éº¼åšå‘¢ï¼Ÿ",
            "è¬è¬å¦³çš„åˆ†äº«ï¼Œæˆ‘æ„Ÿè¦ºæ›´äº†è§£å¦³äº†ã€‚"
        ];
        setTimeout(() => addChatMsg('teacher', responses[Math.floor(Math.random()*responses.length)]), 800);
        input.value = '';
    }

    // --- ç­”é¡Œç³»çµ±é‚è¼¯ ---
    function triggerAction(mode) {
        if(state.stamina <= 0) return addChatMsg('teacher', "é«”åŠ›ä¸è¶³å–”ï¼é»æ“Šå³ä¸Šæ–¹é›»æ± ä¼‘æ¯ä¸€ä¸‹å§ã€‚");
        
        if(mode === 'brush') {
            const lv = prompt("è«‹é¸æ“‡æŒ‘æˆ°é›£åº¦ï¼š\n1.åœ‹å°(50ğŸª™)\n2.åœ‹ä¸­(80ğŸª™)\n3.é«˜ä¸­(120ğŸª™)\n4.å¤§å­¸(160ğŸª™)\n5.ç¢©åš(200ğŸª™)");
            if(lv >= 1 && lv <= 5) startQuiz(parseInt(lv), 'brush');
        } else {
            if(confirm("ğŸ† é–‹å§‹ç«¶è³½æŒ‘æˆ°ï¼šåƒ…è€—è²» 1 é»é«”åŠ›ï¼Œé«˜é›£åº¦ï¼Œé«˜å›å ±ï¼")) {
                startQuiz(5, 'compete'); // ç«¶è³½é¡Œå›ºå®šç‚ºç¢©åšé›£åº¦
            }
        }
    }

    function startQuiz(lv, type) {
        state.stamina -= 1; // ç«¶è³½å’Œåˆ·é¡Œéƒ½æ‰£ 1 é»é«”åŠ›
        state.quiz = { active: true, current: 1, errors: 0, lv: lv, type: type, timerInterval: null };
        
        sessionStorage.setItem('isGuilty', 'true'); // æ¨™è¨˜é€²å…¥ç­”é¡Œ
        document.getElementById('quiz-overlay').style.display = 'flex';
        updateUI();
        loadQuestion();
    }

    function loadQuestion() {
        const lvNames = ['', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'ç¢©åš'];
        document.getElementById('quiz-title-text').innerText = `${lvNames[state.quiz.lv]}é›£åº¦ - ${state.quiz.type==='compete'?'ç«¶è³½é¡Œ':'åˆ·é¡Œæ¨¡å¼'}`;
        document.getElementById('quiz-progress-text').innerText = `ç¬¬ ${state.quiz.current} / 10 é¡Œ (éŒ¯èª¤ï¼š${state.quiz.errors})`;
        
        // æ¨¡æ“¬é¡Œç›®å…§å®¹
        document.getElementById('quiz-question-text').innerText = state.teacher === 'ling' ? 
            `ã€ç†ç§‘ã€‘é—œæ–¼ç”Ÿç‰©é€²åŒ–è«–ï¼Œä¸‹åˆ—å“ªé …æ•˜è¿°æ˜¯æ­£ç¢ºçš„ï¼Ÿ (ç¬¬ ${state.quiz.current} é¡Œ)` : 
            `ã€æ–‡ç§‘ã€‘åˆ†æé€™æ®µå”è©©çš„æ„å¢ƒèˆ‡ä½œè€…æƒ…æ„Ÿã€‚ (ç¬¬ ${state.quiz.current} é¡Œ)`;
        
        const optBox = document.getElementById('quiz-options');
        optBox.innerHTML = '';
        const opts = ["æ­£ç¢ºç­”æ¡ˆé¸é …", "éŒ¯èª¤å¹²æ“¾é¸é … A", "éŒ¯èª¤å¹²æ“¾é¸é … B"]; // å¢åŠ é¸é …å¤šæ¨£æ€§
        opts.sort(() => Math.random() - 0.5).forEach(o => {
            const b = document.createElement('button');
            b.className = 'option-button';
            b.innerText = o;
            b.onclick = () => handleAnswer(o === "æ­£ç¢ºç­”æ¡ˆé¸é …");
            optBox.appendChild(b);
        });

        // è¨ˆæ™‚é‚è¼¯
        clearInterval(state.quiz.timerInterval);
        const timerText = document.getElementById('quiz-timer-text');
        if(state.quiz.lv >= 4 || state.quiz.type === 'compete') {
            timerText.innerText = "âš–ï¸ é«˜éšæŒ‘æˆ°ï¼šä¸è¨ˆæ™‚ (è«‹æ·±æ€)";
        } else {
            let timeLeft = 20;
            timerText.innerText = `â³ å‰©é¤˜ ${timeLeft} ç§’`;
            state.quiz.timerInterval = setInterval(() => {
                timeLeft--;
                timerText.innerText = `â³ å‰©é¤˜ ${timeLeft} ç§’`;
                if (timeLeft <= 0) {
                    clearInterval(state.quiz.timerInterval);
                    alert("æ™‚é–“åˆ°ï¼æœªèƒ½åŠæ™‚ä½œç­”ï¼Œæœ¬æ¬¡æŒ‘æˆ°ç„¡æ•ˆã€‚");
                    concludeQuiz(false); // è¦–ç‚ºå¤±æ•—
                }
            }, 1000);
        }
    }

    function handleAnswer(isCorrect) {
        if (state.quiz.timerInterval) clearInterval(state.quiz.timerInterval); // ç­”é¡Œå¾Œæ¸…é™¤è¨ˆæ™‚å™¨
        if(!isCorrect) state.quiz.errors++;
        
        if(state.quiz.current < 10) {
            state.quiz.current++;
            loadQuestion();
        } else {
            concludeQuiz(true); // ç­”å®Œæ‰€æœ‰é¡Œç›®
        }
    }

    function concludeQuiz(completed) {
        sessionStorage.removeItem('isGuilty'); // è§£é™¤ä½œå¼Šç›£æ§
        clearInterval(state.quiz.timerInterval); // æ¸…é™¤å¯èƒ½æ®˜ç•™çš„è¨ˆæ™‚å™¨

        const errorRate = state.quiz.errors / 10;
        let finalReward = 0;

        if (!completed || errorRate > 0.3) {
            alert(`æ±Ÿè€å¸«ï¼šæŒ‘æˆ°çµæŸï¼Œå¦³éŒ¯äº† ${state.quiz.errors} é¡Œ (éŒ¯èª¤ç‡ ${(errorRate*100).toFixed(0)}%)ã€‚æœ¬æ¬¡ç„¡æ³•ç²å¾—çå‹µï¼Œä½†è«‹åˆ¥æ°£é¤’ï¼`);
        } else {
            // çå‹µè¨ˆç®— (50 -> 200)
            finalReward = (state.quiz.lv * 37.5) + 12.5; 
            if(state.quiz.type === 'compete') finalReward = 500; // ç«¶è³½å›ºå®šé«˜çå‹µ
            
            if(state.isAdmin) finalReward *= 10; // ç®¡ç†è€…åŠ æˆ
            state.coins += Math.round(finalReward);
            alert(`ğŸ‰ å¤ªæ£’äº†ï¼å¦³ç­”å°äº† ${10 - state.quiz.errors} é¡Œï¼Œç²å¾—é‡‘å¹£ ğŸª™${Math.round(finalReward)}ï¼`);
        }

        state.quiz.active = false;
        document.getElementById('quiz-overlay').style.display = 'none';
        updateUI();
        saveState();
    }


    // --- ä»‹é¢åŠŸèƒ½ (åº­é™¢, ç›¸ç°¿, å•†å ´, æ›´è¡£å®¤) ---
    function openYard() {
        document.getElementById('yard-modal').style.display = 'flex';
        // å¦³å¯ä»¥æŠŠ 'yard_background.jpg' æ›¿æ›æˆä½ å¯¦éš›çš„åº­é™¢èƒŒæ™¯åœ–
    }
    function capturePhoto() {
        const photoId = state.photos.length + 1;
        // é€™è£¡å¯ä»¥æ”¾ä¸€å¼µé è¨­çš„è€å¸«ç…§ç‰‡ï¼Œæˆ–è®“ç”¨æˆ¶è‡ªè¡Œä¸Šå‚³
        const photoUrl = `https://via.placeholder.com/160x90?text=Photo+${photoId}`; // æ›¿æ›ç‚ºå¯¦éš›åœ–ç‰‡è·¯å¾‘æˆ–AIç”Ÿæˆ
        state.photos.push({ id: photoId, url: photoUrl, timestamp: new Date().toLocaleString() });
        saveState();
        alert("ğŸ“¸ æ•æ‰åˆ°è€å¸«å€‘çš„å”¯ç¾ç•«é¢ï¼å·²æ”¶è—è‡³ç›¸ç°¿ã€‚");
        close
