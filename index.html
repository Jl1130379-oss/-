<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚ | ç”Ÿå‘½é«”äº’å‹•æ——è‰¦ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-blue: #00f2fe; --neon-pink: #ff00de; --gold: #ffd700;
            --panel-bg: rgba(5, 15, 30, 0.95);
            --char-bg: rgba(0, 0, 0, 0.2);
        }
        * { box-sizing: border-box; font-family: "PingFang TC", sans-serif; cursor: crosshair; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; overflow: hidden; }

        /* å…¨å±€èƒŒæ™¯èˆ‡ HUD æ¡†æ¶ */
        #main-bg {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1542332213-9b5a5a3fad35?w=1920');
            background-size: cover; background-position: center; z-index: -2;
        }
        .hud-frame { position: fixed; inset: 15px; border: 2px solid var(--neon-blue); border-radius: 40px; box-shadow: 0 0 25px var(--neon-blue), inset 0 0 25px var(--neon-blue); pointer-events: none; z-index: 1000; }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
        .top-hud {
            position: fixed; top: 40px; right: 75px; z-index: 1100;
            background: var(--panel-bg); border: 1px solid var(--neon-blue); padding: 12px 30px; border-radius: 50px;
            display: flex; gap: 30px; box-shadow: 0 0 10px var(--neon-blue);
        }
        .hp-bar-bg { width: 100px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 10px; }
        #hp-fill { height: 100%; background: linear-gradient(90deg, var(--neon-pink), #ff77ff); width: 100%; transition: 0.5s; }

        /* å·¦å´å°èˆª */
        #main-nav { position: fixed; left: 45px; top: 120px; display: flex; flex-direction: column; gap: 20px; z-index: 1100; }
        .nav-orb {
            width: 70px; height: 70px; border-radius: 20px; background: var(--panel-bg); border: 1px solid var(--neon-blue);
            display: flex; align-items: center; justify-content: center; font-size: 26px; color: var(--neon-blue);
            cursor: pointer; transition: 0.4s; backdrop-filter: blur(8px);
        }
        .nav-orb.active { background: var(--neon-blue); color: #000; box-shadow: 0 0 30px var(--neon-blue); }

        /* ä¸»è¦å…§å®¹è¦–çª— */
        .viewport {
            position: fixed; left: 145px; right: 50px; top: 90px; bottom: 50px;
            background: var(--panel-bg); border-radius: 35px; border: 1px solid rgba(0,242,254,0.3);
            display: none; padding: 40px; overflow-y: auto; backdrop-filter: blur(20px);
        }

        /* å¤§å»³ï¼šæ±Ÿéˆ´æ±Ÿä¾ç”Ÿæ´»å ´æ™¯ */
        #view-lobby { display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .teacher-area {
            display: flex; justify-content: space-around; align-items: flex-end; height: 80%;
            position: relative;
        }
        .teacher-char {
            width: 300px; height: 500px; border-radius: 25px; border: 2px solid var(--neon-blue);
            background-size: contain; background-repeat: no-repeat; background-position: center bottom;
            position: relative; transition: 0.5s ease-in-out;
        }
        .teacher-char.active { transform: translateY(-20px); box-shadow: 0 0 40px var(--neon-blue); }
        .teacher-char.sleeping { filter: brightness(0.7); }
        .char-bubble {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.95); color: #333; padding: 10px 15px; border-radius: 15px;
            white-space: nowrap; animation: bubbleAnim 0.8s ease-in-out; opacity: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .char-bubble.show { opacity: 1; top: -70px; }
        @keyframes bubbleAnim {
            0% { opacity: 0; transform: translateX(-50%) translateY(0); }
            50% { opacity: 1; transform: translateX(-50%) translateY(-20px); }
            100% { opacity: 1; transform: translateX(-50%) translateY(-20px); }
        }
        .char-name-tag {
            position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 15px; text-align: center; border-radius: 0 0 23px 23px;
        }

        /* ç¾¤èŠå€ */
        .chat-display { height: 400px; overflow-y: auto; background: var(--char-bg); padding: 20px; border-radius: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max-width: 80%; padding: 10px 15px; border-radius: 12px; line-height: 1.4; }
        .chat-msg.teacher { background: rgba(0,242,254,0.1); border-left: 3px solid var(--neon-blue); align-self: flex-start; }
        .chat-msg.user { background: rgba(255,255,255,0.05); align-self: flex-end; }
        
        /* èª²ç¨‹å€ */
        .quiz-opts { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .opt-btn { padding: 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; text-align: left; color: #fff; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .opt-btn:hover { border-color: var(--neon-blue); background: rgba(0,242,254,0.1); }
        .diff-btn { padding: 8px 15px; border: 1px solid var(--neon-blue); background: transparent; color: #fff; border-radius: 5px; cursor: pointer; }
        .diff-btn.active { background: var(--neon-blue); color: #000; }

        /* å•†åŸå€ */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .shop-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .shop-item.owned { filter: brightness(0.6); }
        .shop-item.missed { background: #333; color: #888; text-decoration: line-through; }
        .rarity-tag { position: absolute; top: -10px; right: -10px; background: var(--gold); color: #000; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; }
        .unlock-tag { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }

        #admin-panel { position: fixed; bottom: 35px; right: 35px; color: var(--neon-blue); font-size: 45px; cursor: pointer; z-index: 2000; }
    </style>
</head>
<body onload="bootSystem()">

<div id="main-bg"></div>
<div class="hud-frame"></div>

<div class="top-hud">
    <div><i class="fas fa-coins" style="color:var(--gold)"></i> æ˜ç‡ˆï¼š<span id="coin-val">0</span></div>
    <div>ç”Ÿå‘½å€¼ï¼š<span id="hp-val">100</span>/100 <div class="hp-bar-bg"><div id="hp-fill"></div></div></div>
</div>

<div id="main-nav">
    <div class="nav-orb active" id="nav-lobby" onclick="showView('lobby')"><i class="fas fa-home"></i></div>
    <div class="nav-orb" id="nav-study" onclick="showView('study')"><i class="fas fa-graduation-cap"></i></div>
    <div class="nav-orb" id="nav-chat" onclick="showView('chat')"><i class="fas fa-comments"></i></div>
    <div class="nav-orb" id="nav-shop" onclick="showView('shop')"><i class="fas fa-shopping-bag"></i></div>
</div>

<div id="admin-panel" onclick="adminAccess()"><i class="fas fa-snowflake"></i></div>

<div id="view-lobby" class="viewport">
    <h1 style="color:var(--neon-blue); letter-spacing:8px;">æ±Ÿå®¶æ™ºæ…§ç”Ÿæ´»å¤§å»³</h1>
    <div class="teacher-area">
        <div id="ling-char" class="teacher-char" style="background-image:url('https://api.dicebear.com/7.x/adventurer/svg?seed=JiangLing&clothing=blazer&clothingColor=2c1b18&eyes=variant01')">
            <div id="ling-bubble" class="char-bubble"></div>
            <div class="char-name-tag"><h3>æ±Ÿéˆ´ (ç†ç§‘è€å¸«)</h3><p style="color:var(--gold);">ğŸ‘— æµå‹•æ¥µå…‰è£™</p></div>
        </div>
        <div id="yi-char" class="teacher-char" style="background-image:url('https://api.dicebear.com/7.x/adventurer/svg?seed=JiangYi&clothing=shirt&clothingColor=ffcc99&eyes=variant16')">
            <div id="yi-bubble" class="char-bubble"></div>
            <div class="char-name-tag"><h3>æ±Ÿä¾ (æ–‡ç§‘è€å¸«)</h3><p style="color:var(--gold);">ğŸ‘˜ è½æ«»ç¹½ç´›æ¼¢æœ</p></div>
        </div>
    </div>
    <div style="text-align:center; margin-top:20px;">
        <button onclick="interact('ling')" style="background:var(--neon-blue); color:#000; padding:10px 20px; border-radius:10px; border:none; cursor:pointer;">èˆ‡æ±Ÿéˆ´äº’å‹•</button>
        <button onclick="interact('yi')" style="background:var(--neon-pink); color:#000; padding:10px 20px; border-radius:10px; border:none; cursor:pointer; margin-left:15px;">èˆ‡æ±Ÿä¾äº’å‹•</button>
    </div>
</div>

<div id="view-study" class="viewport">
    <h1 style="color:var(--neon-blue)">èª²ç¨‹æŒ‘æˆ°</h1>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div class="diff-panel">
            <button class="diff-btn active" id="diff-elem" onclick="setDifficulty('åœ‹å°')">åœ‹å° (æ–‡ç§‘)</button>
            <button class="diff-btn" id="diff-univ" onclick="setDifficulty('å¤§å­¸')">å¤§å­¸ (ç†ç§‘)</button>
        </div>
        <div id="timer-display" style="font-size:2.5rem; color:var(--neon-pink);">--:--</div>
    </div>
    <div style="background:var(--char-bg); padding:30px; border-radius:20px; border:1px solid rgba(0,242,254,0.1);">
        <h2 id="quiz-text" style="margin-top:0;"></h2>
        <div id="quiz-options" class="quiz-opts"></div>
    </div>
</div>

<div id="view-chat" class="viewport">
    <h1 style="color:var(--neon-blue)">æ±Ÿå®¶å¸«ç”Ÿäº¤æµç¾¤</h1>
    <div id="chat-box" class="chat-display"></div>
    <div style="margin-top:20px; display:flex; gap:10px;">
        <input type="text" id="chat-input" style="flex:1; background:transparent; border:1px solid var(--neon-blue); padding:15px; border-radius:10px; color:#fff;" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button onclick="sendChatMessage()" style="background:var(--neon-blue); border:none; padding:15px 25px; border-radius:10px; color:#000; font-weight:bold; cursor:pointer;">ç™¼é€</button>
    </div>
</div>

<div id="view-shop" class="viewport">
    <h1 style="color:var(--neon-blue)">æ±Ÿå®¶æœè£å…¸è—é¤¨</h1>
    <div class="shop-grid" id="outfit-shop"></div>
    <button onclick="healPlayer()" style="background:var(--gold); color:#000; padding:15px 30px; border-radius:10px; border:none; margin-top:30px; cursor:pointer;"><i class="fas fa-heart"></i> 1000 æ˜ç‡ˆ âœ +20 ç”Ÿå‘½</button>
</div>

<script>
    let playerState = {
        coin: 0,
        hp: 100,
        difficulty: 'åœ‹å°',
        unlockedOutfits: { // ç©å®¶å·²æ“æœ‰çš„æœè£
            'æ¥µå…‰è£™': true, 'æ¼¢æœ': true
        },
        adminMode: false,
        lastOutfitAwardTime: 0 // è¨˜éŒ„ä¸Šæ¬¡ç²å¾—æœè£çå‹µçš„æ™‚é–“ï¼Œç”¨æ–¼ã€ŒéŒ¯éå³å¤±ã€
    };

    let gameTime = 0; // æ¨¡æ“¬éŠæˆ²æ™‚é–“ï¼Œå½±éŸ¿è€å¸«è¡Œç‚º
    let teacherMood = { ling: 'normal', yi: 'normal' }; // è€å¸«å¿ƒæƒ…ï¼šnormal, hungry, sleepy, playing
    let activeTimer;
    let autoSaveInterval;
    let teacherLifeInterval;

    // é¡Œç›®è³‡æ–™åº«
    const quizDB = {
        'åœ‹å°': [{
            q: "ã€Œæ˜¥çœ ä¸è¦ºæ›‰ï¼Œè™•è™•èå•¼é³¥ã€å‡ºè‡ªèª°çš„è©©ï¼Ÿ",
            o: ["å­Ÿæµ©ç„¶", "æç™½", "æœç”«"], a: 0, time: 180, rewardOutfit: 'æ«»èŠ±å’Œæœ'
        }, {
            q: "å¤ªé™½ç³»æœ€å¤§çš„è¡Œæ˜Ÿæ˜¯ï¼Ÿ",
            o: ["æœ¨æ˜Ÿ", "åœŸæ˜Ÿ", "åœ°çƒ"], a: 0, time: 180, rewardOutfit: 'æ˜Ÿè¾°æŠ«é¢¨'
        }],
        'å¤§å­¸': [{
            q: "åœ¨é‡å­åŠ›å­¸ä¸­ï¼Œä¸ç¢ºå®šæ€§åŸç†çš„æå‡ºè€…æ˜¯ï¼Ÿ",
            o: ["æµ·æ£®å ¡", "è–›ä¸æ ¼", "æ„›å› æ–¯å¦"], a: 0, time: 0, rewardOutfit: 'æœªä¾†æˆ°ç”²'
        }, {
            q: "æ ¹æ“šç‹¹ç¾©ç›¸å°è«–ï¼Œç•¶ç‰©é«”æ¥è¿‘å…‰é€Ÿæ™‚ï¼Œå…¶æ™‚é–“æœƒï¼Ÿ",
            o: ["è®Šæ…¢", "è®Šå¿«", "ä¸è®Š"], a: 0, time: 0, rewardOutfit: 'æ™‚ç©ºæ—…è¡Œæœ'
        }]
    };

    // æœè£è³‡æ–™åº«
    const outfitDB = [
        { id: 'æ¥µå…‰è£™', name: 'æµå‹•æ¥µå…‰è£™', rarity: 'å²è©©', price: 0, img: 'https://api.dicebear.com/7.x/adventurer/svg?seed=JiangLing&clothing=blazer&clothingColor=2c1b18&accessories=glasses', ownedBy: 'ling' },
        { id: 'æ¼¢æœ', name: 'è½æ«»ç¹½ç´›æ¼¢æœ', rarity: 'å²è©©', price: 0, img: 'https://api.dicebear.com/7.x/adventurer/svg?seed=JiangYi&clothing=shirt&clothingColor=ffcc99&accessories=sunglasses', ownedBy: 'yi' },
        { id: 'æ«»èŠ±å’Œæœ', name: 'æ«»èŠ±å’Œæœ', rarity: 'ç¨€æœ‰', price: 1500, img: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Sakura&clothing=turtleneck&clothingColor=f7d0dc', obtained: false, missed: false },
        { id: 'æ˜Ÿè¾°æŠ«é¢¨', name: 'æ˜Ÿè¾°æŠ«é¢¨', rarity: 'å‚³èªª', price: 3000, img: 'https://api.dicebear.com/7.x/adventurer/svg?seed=StarCape&clothing=hoodie&clothingColor=3a3a5a', obtained: false, missed: false },
        { id: 'æœªä¾†æˆ°ç”²', name: 'æœªä¾†æˆ°ç”²', rarity: 'å‚³èªª', price: 5000, img: 'https://api.dicebear.com/7.x/adventurer/svg?seed=FutureArmor&clothing=overall&clothingColor=6a5acd', obtained: false, missed: false },
        { id: 'æ™‚ç©ºæ—…è¡Œæœ', name: 'æ™‚ç©ºæ—…è¡Œæœ', rarity: 'å‚³èªª', price: 5000, img: 'https://api.dicebear.com/7.x/adventurer/svg?seed=TimeTravel&clothing=sweater&clothingColor=5a7a9a', obtained: false, missed: false }
    ];

    // --- éŠæˆ²å•Ÿå‹•èˆ‡åŸºç¤åŠŸèƒ½ ---
    function bootSystem() {
        loadGameState();
        showView('lobby');
        updateUI();
        startTeacherLifeCycle();
        autoSaveInterval = setInterval(saveGameState, 30000); // æ¯30ç§’è‡ªå‹•å„²å­˜
    }

    function saveGameState() {
        localStorage.setItem('jiangCityState', JSON.stringify(playerState));
        localStorage.setItem('jiangCityOutfits', JSON.stringify(outfitDB));
        addChatMsg('ç³»çµ±', 'éŠæˆ²é€²åº¦å·²è‡ªå‹•å„²å­˜ã€‚');
    }

    function loadGameState() {
        const savedState = localStorage.getItem('jiangCityState');
        const savedOutfits = localStorage.getItem('jiangCityOutfits');
        if (savedState) {
            playerState = JSON.parse(savedState);
        }
        if (savedOutfits) {
            const loadedOutfits = JSON.parse(savedOutfits);
            // åˆä½µæ–°èˆŠæœè£ï¼Œç¢ºä¿æ–°å¢çš„æœè£ä¹Ÿæœƒè¢«è¼‰å…¥
            outfitDB.forEach(newOutfit => {
                const existing = loadedOutfits.find(o => o.id === newOutfit.id);
                if (existing) {
                    Object.assign(newOutfit, existing); // è¼‰å…¥èˆŠçš„ç‹€æ…‹
                }
            });
        }
    }

    function updateUI() {
        document.getElementById('coin-val').innerText = playerState.coin;
        document.getElementById('hp-val').innerText = playerState.hp;
        document.getElementById('hp-fill').style.width = playerState.hp + "%";
        if (playerState.hp <= 20 && playerState.hp > 0) {
            document.getElementById('hp-fill').style.background = 'linear-gradient(90deg, #ff0000, #ff7700)';
        } else if (playerState.hp === 0) {
            document.getElementById('hp-fill').style.background = '#888';
        } else {
            document.getElementById('hp-fill').style.background = 'linear-gradient(90deg, var(--neon-pink), #ff77ff)';
        }
    }

    function showView(id) {
        document.querySelectorAll('.viewport').forEach(v => v.style.display = 'none');
        document.querySelectorAll('.nav-orb').forEach(n => n.classList.remove('active'));
        document.getElementById('view-' + id).style.display = 'block';
        document.getElementById('nav-' + id).classList.add('active');

        // æ ¹æ“šè¦–åœ–åŸ·è¡Œåˆå§‹åŒ–é‚è¼¯
        if (id === 'study') loadQuiz();
        if (id === 'shop') renderOutfitShop();
        if (id === 'chat') addChatMsg('ç³»çµ±', 'æ­¡è¿ä¾†åˆ°ç¾¤èŠï¼Œè€å¸«å€‘éƒ½åœ¨é€™è£¡ã€‚'); // ç¢ºä¿é€²å…¥èŠå¤©å®¤æœ‰æ­¡è¿èª
        
        // è€å¸«æ ¹æ“šç©å®¶è¡Œç‚ºèªªè©±
        if (id !== 'lobby') { // é›¢é–‹å¤§å»³æ™‚è€å¸«æœƒèªªè©±
            speakTeacher('ling', `å»${idText(id)}äº†å•Šï¼Œåˆ¥ç©å¤ªæ™šã€‚`);
            speakTeacher('yi', `è¨˜å¾—æŠŠé‡è¦çš„äº‹è¾¦å¥½å–”ã€‚`);
        } else { // å›åˆ°å¤§å»³
             speakTeacher('ling', `æ­¡è¿å›å®¶ï¼`);
        }
    }

    function idText(id) {
        if (id === 'study') return 'èª²ç¨‹';
        if (id === 'chat') return 'ç¾¤èŠ';
        if (id === 'shop') return 'å•†åŸ';
        return 'æœªçŸ¥å€åŸŸ';
    }

    // --- AI å®¶é•·äº’å‹•èˆ‡ç”Ÿæ´» ---
    function startTeacherLifeCycle() {
        teacherLifeInterval = setInterval(() => {
            gameTime++;
            // éš¨æ©Ÿè§¸ç™¼è€å¸«ç‹€æ…‹è®ŠåŒ– (åƒå–ç©ç¡)
            if (gameTime % 5 === 0) { // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
                if (Math.random() < 0.4) { // 40%æ©Ÿç‡æ”¹è®Šç‹€æ…‹
                    const r = Math.random();
                    if (r < 0.25) teacherMood.ling = 'hungry';
                    else if (r < 0.5) teacherMood.ling = 'sleepy';
                    else if (r < 0.75) teacherMood.ling = 'playing';
                    else teacherMood.ling = 'normal';
                }
                if (Math.random() < 0.4) { // 40%æ©Ÿç‡æ”¹è®Šç‹€æ…‹
                    const r = Math.random();
                    if (r < 0.25) teacherMood.yi = 'hungry';
                    else if (r < 0.5) teacherMood.yi = 'sleepy';
                    else if (r < 0.75) teacherMood.yi = 'playing';
                    else teacherMood.yi = 'normal';
                }
            }
            updateTeacherVisualsAndDialogue();
        }, 1000); // æ¯ç§’æ›´æ–°
    }

    function updateTeacherVisualsAndDialogue() {
        const lingChar = document.getElementById('ling-char');
        const yiChar = document.getElementById('yi-char');
        const lingBubble = document.getElementById('ling-bubble');
        const yiBubble = document.getElementById('yi-bubble');

        // é‡ç½®å‹•ç•«
        lingChar.classList.remove('active', 'sleeping');
        yiChar.classList.remove('active', 'sleeping');
        lingBubble.classList.remove('show');
        yiBubble.classList.remove('show');

        // æ±Ÿéˆ´ç‹€æ…‹
        let lingDialogue = "";
        switch (teacherMood.ling) {
            case 'hungry': lingDialogue = "æœ‰é»é¤“äº†ï¼Œæƒ³åƒé»å¿ƒ..."; break;
            case 'sleepy': lingDialogue = "zzz... å¥½çå•Š..."; lingChar.classList.add('sleeping'); break;
            case 'playing': lingDialogue = "é€™å€‹éŠæˆ²çœŸæœ‰è¶£ï¼"; break;
            default: lingDialogue = "ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ"; break;
        }
        lingBubble.innerText = lingDialogue;
        lingBubble.classList.add('show'); // é¡¯ç¤ºæ°£æ³¡

        // æ±Ÿä¾ç‹€æ…‹
        let yiDialogue = "";
        switch (teacherMood.yi) {
            case 'hungry': yiDialogue = "æ™šé¤åƒä»€éº¼å¥½å‘¢ï¼Ÿ"; break;
            case 'sleepy': yiDialogue = "å“ˆæ¬ ... è©²ä¼‘æ¯ä¸€ä¸‹äº†ã€‚"; yiChar.classList.add('sleeping'); break;
            case 'playing': yiDialogue = "å—¯... é€™ä¸€æ­¥æ£‹æ€éº¼èµ°ï¼Ÿ"; break;
            default: yiDialogue = "æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ã€‚"; break;
        }
        yiBubble.innerText = yiDialogue;
        yiBubble.classList.add('show'); // é¡¯ç¤ºæ°£æ³¡

        // ç§»é™¤èˆŠçš„æ°£æ³¡é¡¯ç¤º
        setTimeout(() => {
            lingBubble.classList.remove('show');
            yiBubble.classList.remove('show');
        }, 3000); // æ°£æ³¡é¡¯ç¤º3ç§’
    }

    function interact(teacherId) {
        const charElement = document.getElementById(`${teacherId}-char`);
        charElement.classList.add('active'); // å¢åŠ äº’å‹•å‹•ç•«
        setTimeout(() => charElement.classList.remove('active'), 800);

        let msg = "";
        if (teacherId === 'ling') {
            msg = `æ±Ÿéˆ´è€å¸«çš„ç‹€æ…‹ï¼š${teacherMood.ling}ã€‚èˆ‡å¦³å°è©±ï¼šå¦³æœ€è¿‘çš„ç†ç§‘èª²ç¨‹é€²åº¦å¦‚ä½•ï¼Ÿ`;
        } else {
            msg = `æ±Ÿä¾è€å¸«çš„ç‹€æ…‹ï¼š${teacherMood.yi}ã€‚èˆ‡å¦³å°è©±ï¼šæ–‡ç§‘æ–¹é¢æœ‰ä»€éº¼æƒ³è¨è«–çš„å—ï¼Ÿ`;
        }
        speakTeacher(teacherId, msg);
        addChatMsg(teacherId === 'ling' ? 'æ±Ÿéˆ´' : 'æ±Ÿä¾', msg); // åŒæ­¥åˆ°èŠå¤©å®¤
    }

    function speakTeacher(teacherId, message) {
        const bubble = document.getElementById(`${teacherId}-bubble`);
        bubble.innerText = message;
        bubble.classList.add('show');
        setTimeout(() => bubble.classList.remove('show'), 3000);
    }

    // --- èª²ç¨‹åŠŸèƒ½ ---
    function setDifficulty(d) {
        playerState.difficulty = d;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`diff-${d === 'åœ‹å°' ? 'elem' : 'univ'}`).classList.add('active');
        loadQuiz();
        addChatMsg('ç³»çµ±', `èª²ç¨‹é›£åº¦å·²è¨­å®šç‚ºï¼š${d}ã€‚`);
        speakTeacher('ling', `é€™æ¬¡çš„${d}èª²ç¨‹ï¼Œå¦³æº–å‚™å¥½äº†å—ï¼Ÿ`);
    }

    function loadQuiz() {
        clearInterval(activeTimer);
        const currentQuizSet = quizDB[playerState.difficulty];
        const quiz = currentQuizSet[Math.floor(Math.random() * currentQuizSet.length)]; // éš¨æ©Ÿé¸é¡Œ

        document.getElementById('quiz-text').innerText = quiz.q;
        document.getElementById('quiz-options').innerHTML = quiz.o.map((opt, i) =>
            `<button class="opt-btn" onclick="submitAnswer(${i === quiz.a}, '${quiz.rewardOutfit}')">${opt}</button>`
        ).join('');

        if (quiz.time > 0) startQuizTimer(quiz.time);
        else document.getElementById('timer-display').innerText = "âˆ";
    }

    function startQuizTimer(seconds) {
        let remaining = seconds;
        activeTimer = setInterval(() => {
            remaining--;
            document.getElementById('timer-display').innerText = `${Math.floor(remaining / 60)}:${(remaining % 60).toString().padStart(2, '0')}`;
            if (remaining <= 0) {
                clearInterval(activeTimer);
                submitAnswer(false, null); // æ™‚é–“åˆ°æœªç­”ï¼Œè¦–ç‚ºéŒ¯èª¤
            }
        }, 1000);
    }

    function submitAnswer(isCorrect, rewardOutfitId) {
        clearInterval(activeTimer);
        let teacherSay = '';
        if (isCorrect) {
            playerState.coin += 500;
            teacherSay = `å¤ªæ£’äº†ï¼ç­”å°äº†ï¼Œé€™æ˜¯å¦³çš„ 500 æ˜ç‡ˆï¼`;
            if (rewardOutfitId) {
                const outfit = outfitDB.find(o => o.id === rewardOutfitId);
                if (outfit && !outfit.obtained && !outfit.missed) {
                    // ã€ŒéŒ¯éå³å¤±ã€é‚è¼¯ï¼šå¦‚æœé›¢ä¸Šæ¬¡ç²å¾—çå‹µè¶…éä¸€å®šæ™‚é–“ï¼Œé€™æ¬¡çš„çå‹µå°±éŒ¯éäº†
                    const now = Date.now();
                    const oneMinute = 60 * 1000; // ç¯„ä¾‹ï¼šå¦‚æœ1åˆ†é˜å…§æ²’æ‹¿ï¼Œå°±éŒ¯é

                    if (playerState.lastOutfitAwardTime > 0 && (now - playerState.lastOutfitAwardTime > oneMinute)) {
                        outfit.missed = true;
                        addChatMsg('ç³»çµ±', `âš ï¸ å¦³éŒ¯éäº†ç¨€æœ‰æœè£ã€Œ${outfit.name}ã€ï¼ä¸‹æ¬¡è«‹æŠŠæ¡æ©Ÿæœƒã€‚`);
                    } else {
                        outfit.obtained = true;
                        playerState.unlockedOutfits[outfit.id] = true;
                        addChatMsg('ç³»çµ±', `ğŸ‰ æ­å–œï¼å¦³è§£é–äº†ç¨€æœ‰æœè£ï¼šã€Œ${outfit.name}ã€ï¼å‰å¾€å•†åŸæŸ¥çœ‹ã€‚`);
                        playerState.lastOutfitAwardTime = now; // æ›´æ–°ç²å¾—çå‹µæ™‚é–“
                        speakTeacher('ling', `å¦³çš„çœ¼å…‰ä¸éŒ¯ï¼Œé€™ä»¶è¡£æœå¾ˆé©åˆå¦³ï¼`);
                    }
                }
            }
        } else {
            playerState.hp -= 5;
            teacherSay = `å¯æƒœï¼Œç­”éŒ¯äº†ï¼Œç”Ÿå‘½å€¼æ‰£é™¤ 5 é»ï¼`;
        }
        addChatMsg(playerState.difficulty === 'åœ‹å°' ? 'æ±Ÿä¾' : 'æ±Ÿéˆ´', teacherSay);
        updateUI();
        if (playerState.hp <= 0) {
            alert("ç”Ÿå‘½å€¼è€—ç›¡ï¼éŠæˆ²çµæŸã€‚è«‹ç®¡ç†å“¡åŒæ­¥è³‡æºã€‚");
            playerState.hp = 0;
            updateUI();
        } else {
            loadQuiz(); // ç¹¼çºŒä¸‹ä¸€é¡Œ
        }
    }

    // --- ç¾¤èŠåŠŸèƒ½ ---
    function addChatMsg(sender, text) {
        const chatBox = document.getElementById('chat-box');
        const msgElement = document.createElement('div');
        msgElement.className = `chat-msg ${sender === 'å¦³' ? 'user' : 'teacher'}`;
        msgElement.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatBox.appendChild(msgElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendChatMessage() {
        const input = document.getElementById('chat-
