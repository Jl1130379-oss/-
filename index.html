<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±Ÿå®¶æ™ºæ…§åŸå¸‚ - çµ‚æ¥µç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --gold: #d4af37; --white: rgba(255,255,255,0.95); --error: #ff4757; }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; transition: 0.3s ease; }
        body { margin: 0; background: #1a1a1a; color: #333; height: 100vh; overflow: hidden; }

        #world-bg { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.3)), url('æ±Ÿè€å¸«åˆç…§.jpg'); background-size: cover; background-position: center; z-index: -1; }
        
        /* é›ªèŠ±ç³»çµ± */
        .snowflake { position: fixed; top: -10%; color: white; cursor: pointer; z-index: 1000; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* å°èˆª */
        #sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 200px; background: var(--white); display: flex; flex-direction: column; padding-top: 40px; z-index: 100; box-shadow: 2px 0 20px rgba(0,0,0,0.2); }
        .nav-link { padding: 18px 25px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #eee; text-decoration: none; color: var(--main); }
        .nav-link:hover { background: var(--main); color: white; }

        /* ç‹€æ…‹æ¬„ */
        .status-bar { position: fixed; top: 20px; right: 30px; display: flex; gap: 15px; z-index: 100; }
        .stat-box { background: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; }

        /* AI ç¾¤èŠè¦–çª— */
        #chat-window { position: fixed; bottom: 20px; right: 20px; width: 380px; height: 550px; background: #f0f2f5; border-radius: 25px; display: none; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); z-index: 500; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .chat-header { background: var(--main); color: white; padding: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg.teacher { background: white; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #2c3e50; }
        .msg.user { background: var(--main); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ctrl { padding: 15px; background: white; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { display: flex; gap: 8px; }
        input#user-text { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none; }

        /* ç­”é¡Œé®ç½© */
        #quiz-overlay { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .btn-opt { padding: 15px 40px; margin: 10px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #eee; background: white; cursor: pointer; width: 320px; font-weight: bold; }
        .btn-opt:hover { border-color: var(--gold); background: #fffcf0; }
        
        /* ç®¡ç†è€…æ¨¡å¼ UI */
        .admin-glow { box-shadow: 0 0 15px var(--gold) !important; border: 2px solid var(--gold) !important; }
    </style>
</head>
<body onload="init()">

<div id="world-bg"></div>
<div id="snow-container"></div>

<div id="sidebar">
    <div style="text-align:center; padding:20px; font-weight:900; color:var(--gold); font-size:1.2rem; letter-spacing: 2px;">æ±Ÿå®¶æ™ºæ…§åŸå¸‚</div>
    <div class="nav-link" onclick="openChat('ling')">ğŸ‘©â€âš•ï¸ æ±Ÿéˆ´è€å¸« (ç†ç§‘)</div>
    <div class="nav-link" onclick="openChat('yi')">ğŸ¨ æ±Ÿä¾è€å¸« (æ–‡ç§‘)</div>
    <div class="nav-link" onclick="enterYard()">ğŸ¡ æ±Ÿå®¶åº­é™¢</div>
    <div class="nav-link" onclick="openAlbum()">ğŸ–¼ï¸ æ±Ÿè€å¸«ç›¸ç°¿</div>
    <div class="nav-link" onclick="openShop()">ğŸ›’ åŸå¸‚å•†å ´</div>
</div>

<div class="status-bar">
    <div class="stat-box" onclick="refillStamina()" style="cursor:pointer;" title="é»æ“Šè£œå……é«”åŠ›">âš¡ <span id="sta">10</span></div>
    <div class="stat-box">ğŸª™ <span id="coin">500</span></div>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span id="chat-name">æ±Ÿè€å¸«ç¾¤èŠ</span>
        <span onclick="document.getElementById('chat-window').style.display='none'" style="cursor:pointer;">âœ•</span>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-ctrl">
        <div class="chat-input-area">
            <input type="text" id="user-text" placeholder="è·Ÿè€å¸«èŠèŠå¤©..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" style="border:none; background:var(--gold); color:white; border-radius:10px; padding:0 15px; cursor:pointer;">ç™¼é€</button>
        </div>
        <div style="display:flex; gap:5px;">
            <button onclick="prepareQuiz('brush')" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; background:#f8f9fa; cursor:pointer; font-weight:bold;">æˆ‘è¦åˆ·é¡Œ</button>
            <button onclick="prepareQuiz('compete')" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--gold); background:white; cursor:pointer; font-weight:bold; color:var(--gold);">æˆ‘æƒ³æŒ‘æˆ°ç«¶è³½</button>
        </div>
    </div>
</div>

<div id="quiz-overlay">
    <h2 id="q-lv-title" style="color:var(--main);">é›£åº¦åŠ è¼‰ä¸­</h2>
    <div id="q-progress" style="margin-bottom:20px; color:var(--gold); font-weight:bold; font-size:1.2rem;">ç¬¬ 1 / 10 é¡Œ</div>
    <p id="q-content" style="font-size:1.5rem; padding:0 10%; text-align:center; line-height:1.6; min-height:100px;"></p>
    <div id="q-options"></div>
    <div id="q-timer" style="margin-top:30px; font-weight:bold; color:var(--error);"></div>
    <p style="color:#999; margin-top:20px; font-size:0.8rem;">âš ï¸ åš´ç¦åˆ‡æ›åˆ†é æˆ–é‡æ–°æ•´ç†ï¼Œé•è€…æ‰£é™¤é«”åŠ›ä¸¦å–æ¶ˆè³‡æ ¼ã€‚</p>
</div>

<script>
    // æ ¸å¿ƒæ•¸æ“š
    let state = {
        coins: 500, stamina: 10, teacher: '', isAdmin: false,
        quiz: { active: false, current: 0, errors: 0, lv: 1, type: '', reward: 0 }
    };

    const teacherData = {
        ling: { name: 'æ±Ÿéˆ´', intro: 'æº–å‚™å¥½é€²å…¥ç†æ€§çš„é†«å­¸ä¸–ç•Œäº†å—ï¼Ÿ' },
        yi: { name: 'æ±Ÿä¾', intro: 'è®“æˆ‘å€‘åœ¨æ–‡å­¸èˆ‡è—è¡“ä¸­æ¼«æ­¥å§ã€‚' }
    };

    // åˆå§‹åŒ–
    function init() {
        // åä½œå¼Šåµæ¸¬ï¼šè‹¥ session ä¸­æœ‰æœªå®Œæˆçš„ç­”é¡Œæ¨™è¨˜
        if (sessionStorage.getItem('inQuiz') === 'true') {
            let s = parseInt(localStorage.getItem('sta') || 10);
            state.stamina = Math.max(0, s - 2);
            alert("âš ï¸ ç³»çµ±åµæ¸¬åˆ°æ‚¨åœ¨ç­”é¡Œä¸­é€”éæ³•é‡æ•´é é¢ï¼å·²æ‰£é™¤ 2 é»é«”åŠ›ä½œç‚ºè™•ç½°ã€‚");
            saveState();
        } else {
            state.stamina = parseInt(localStorage.getItem('sta')) || 10;
            state.coins = parseInt(localStorage.getItem('coin')) || 500;
        }

        updateUI();
        setInterval(createSnow, 400);

        // ç¦æ­¢åˆ‡æ›åˆ†é åµæ¸¬
        window.onblur = () => {
            if(state.quiz.active) {
                alert("æ±Ÿè€å¸«ï¼šç­”é¡Œæ™‚è«‹ä¿æŒå°ˆæ³¨ï¼åµæ¸¬åˆ°é›¢é–‹é é¢ï¼Œæœ¬æ¬¡æŒ‘æˆ°ç„¡æ•ˆã€‚");
            }
        };
    }

    // AI ç¾¤èŠåŠŸèƒ½
    function openChat(t) {
        state.teacher = t;
        const win = document.getElementById('chat-window');
        win.style.display = 'flex';
        document.getElementById('chat-name').innerText = `èˆ‡ ${teacherData[t].name} è€å¸«å°è©±`;
        addMsg('teacher', `å“ˆå›‰ï¼æˆ‘æ˜¯${teacherData[t].name}è€å¸«ã€‚${teacherData[t].intro}`);
    }

    function sendChat() {
        const input = document.getElementById('user-text');
        if(!input.value.trim()) return;
        addMsg('user', input.value);
        
        // æ¨¡æ“¬ AI å›è¦†
        const responses = [
            "é€™æ˜¯ä¸€å€‹å¾ˆæœ‰è¶£çš„è§€é»ï¼Œå¦³ç¸½æ˜¯èƒ½å¾ä¸åŒè§’åº¦çœ‹å•é¡Œã€‚",
            "æˆ‘æ˜ç™½äº†ï¼Œé€™ç¢ºå¯¦å€¼å¾—æˆ‘å€‘æ·±å…¥æ¢è¨ã€‚",
            "ç„¡è«–é‡åˆ°ä»€éº¼å›°é›£ï¼Œæ±Ÿè€å¸«éƒ½æœƒé™ªå¦³ä¸€èµ·é¢å°çš„ã€‚",
            "ä»Šå¤©çš„å¿ƒæƒ…ä¸éŒ¯å§ï¼Ÿè¦ä¸è¦è·Ÿæˆ‘åˆ†äº«æ›´å¤šï¼Ÿ",
            "é€™è®“æˆ‘æƒ³èµ·äº†ä¸€å€‹éå¸¸æœ‰æ„ç¾©çš„æ•…äº‹..."
        ];
        setTimeout(() => addMsg('teacher', responses[Math.floor(Math.random()*responses.length)]), 800);
        input.value = '';
    }

    function addMsg(role, text) {
        const box = document.getElementById('chat-msgs');
        box.innerHTML += `<div class="msg ${role}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // ç­”é¡Œç³»çµ±é‚è¼¯
    function prepareQuiz(mode) {
        if(state.stamina <= 0) return addMsg('teacher', "é«”åŠ›ä¸è¶³å–”ï¼é»æ“Šå³ä¸Šæ–¹é›»æ± ä¼‘æ¯ä¸€ä¸‹å§ã€‚");
        
        if(mode === 'brush') {
            const lv = prompt("é¸æ“‡é›£åº¦ (1:åœ‹å° 2:åœ‹ä¸­ 3:é«˜ä¸­ 4:å¤§å­¸ 5:ç¢©åš)");
            if(lv >= 1 && lv <= 5) {
                startQuiz(parseInt(lv), 'brush');
            }
        } else {
            // ç«¶è³½æ¨¡å¼
            if(confirm("ç¢ºå®šè¦é–‹å§‹ç«¶è³½æŒ‘æˆ°å—ï¼Ÿç«¶è³½é¡Œé›£åº¦é«˜ä½†åªéœ€è€—è²» 1 é»é«”åŠ›ï¼")) {
                startQuiz(5, 'compete');
            }
        }
    }

    function startQuiz(lv, type) {
        // ç«¶è³½åªæ‰£1é»ï¼Œä¸€èˆ¬åˆ·é¡Œæ‰£2é»(æˆ–è‡ªå®šç¾©)
        const cost = (type === 'compete') ? 1 : 1; 
        state.stamina -= cost;
        state.quiz = { active: true, current: 1, errors: 0, lv: lv, type: type };
        
        sessionStorage.setItem('inQuiz', 'true');
        document.getElementById('quiz-overlay').style.display = 'flex';
        updateUI();
        loadQuestion();
    }

    function loadQuestion() {
        const lvNames = ['', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'ç¢©åš'];
        document.getElementById('q-lv-title').innerText = `${lvNames[state.quiz.lv]}é›£åº¦ - ${state.quiz.type === 'compete' ? 'ğŸ† ç«¶è³½æ¨¡å¼' : 'ğŸ“– æ—¥å¸¸åˆ·é¡Œ'}`;
        document.getElementById('q-progress').innerText = `ç¬¬ ${state.quiz.current} / 10 é¡Œ`;
        
        // æ¨¡æ“¬é¡Œç›®
        const qContent = state.teacher === 'ling' ? "ã€ç†ç§‘é¡Œã€‘é—œæ–¼ç´°èƒèƒ½é‡å·¥å» çš„æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ" : "ã€æ–‡ç§‘é¡Œã€‘é€™å¥å¤è©©çš„ä½œè€…æ˜¯èª°ï¼Ÿ";
        document.getElementById('q-content').innerText = qContent;
        
        const box = document.getElementById('q-options');
        box.innerHTML = '';
        const options = ["é€™æ˜¯æ­£ç¢ºé¸é …", "é€™æ˜¯å¹²æ“¾é¸é …"];
        options.sort(() => Math.random() - 0.5).forEach(opt => {
            const b = document.createElement('button');
            b.className = 'btn-opt';
            b.innerText = opt;
            b.onclick = () => handleAnswer(opt === "é€™æ˜¯æ­£ç¢ºé¸é …");
            box.appendChild(b);
        });

        // é›£åº¦è¨ˆæ™‚
        const timerBox = document.getElementById('q-timer');
        if(state.quiz.lv >= 4 || state.quiz.type === 'compete') {
            timerBox.innerText = "âš–ï¸ é«˜éšæŒ‘æˆ°ï¼šä¸è¨ˆæ™‚ï¼Œè«‹æ·±æ€ç†Ÿæ…®ã€‚";
        } else {
            timerBox.innerText = "â³ æ€è€ƒæ™‚é–“ï¼š20 ç§’";
        }
    }

    function handleAnswer(isRight) {
        if(!isRight) state.quiz.errors++;
        
        if(state.quiz.current < 10) {
            state.quiz.current++;
            loadQuestion();
        } else {
            concludeQuiz();
        }
    }

    function concludeQuiz() {
        sessionStorage.setItem('inQuiz', 'false');
        const errorRate = state.quiz.errors / 10;
        let reward = 0;

        if(errorRate > 0.3) {
            alert(`æ±Ÿè€å¸«ï¼šé€™å¥—é¡Œå¦³éŒ¯äº† ${state.quiz.errors} é¡Œï¼ŒéŒ¯èª¤ç‡è¶…é 30%ï¼Œæœ¬æ¬¡ç„¡æ³•ç²å¾—çå‹µ... é«”åŠ›å·²è€—è²»ï¼Œè¦å†åŠ æ²¹å–”ï¼`);
        } else {
            // çå‹µéå¢ 50 -> 200
            reward = (state.quiz.lv * 37.5) + 12.5; 
            if(state.quiz.type === 'compete') reward = 500; // ç«¶è³½é«˜é¡çå‹µ
            
            if(state.isAdmin) reward *= 10;
            state.coins += Math.round(reward);
            alert(`ğŸ‰ æ­å–œå®Œæˆï¼ç­”å° ${10 - state.quiz.errors} é¡Œï¼Œç²å¾—é‡‘å¹£ ğŸª™${Math.round(reward)}ï¼`);
        }

        state.quiz.active = false;
        document.getElementById('quiz-overlay').style.display = 'none';
        updateUI();
        saveState();
    }

    // ç³»çµ±åŠŸèƒ½
    function createSnow() {
        const s = document.createElement('div');
        s.className = 'snowflake'; s.innerText = 'â„ï¸';
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = (Math.random() * 3 + 4) + 's';
        s.onclick = () => {
            const code = prompt("ç™¼ç¾éš±è—é›ªèŠ±ï¼è«‹è¼¸å…¥ç®¡ç†è€…é©—è­‰ç¢¼ï¼š");
            if(code === "æ±Ÿæ†¶å©·") {
                state.isAdmin = true;
                state.coins += 1000;
                document.querySelector('.status-bar').classList.add('admin-glow');
                updateUI();
                alert("ğŸ‘‘ æ­¡è¿ç®¡ç†è€…æ±Ÿæ†¶å©·ï¼1000å…ƒå·²æ’¥ä»˜ï¼Œå•†å ´1æŠ˜ç‰¹æ¬Šèˆ‡ç„¡é™é‡‘å¹£åŠ æˆå·²å•Ÿå‹•ã€‚");
            }
        };
        document.getElementById('snow-container').appendChild(s);
        setTimeout(() => s.remove(), 7000);
    }

    function updateUI() {
        document.getElementById('coin').innerText = state.coins;
        document.getElementById('sta').innerText = state.stamina;
    }

    function refillStamina() {
        state.stamina = 10;
        updateUI();
        saveState();
        alert("æ±Ÿéˆ´ï¼šä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ï¼Œé«”åŠ›å·²è£œå……å®Œç•¢ï¼");
    }

    function saveState() {
        localStorage.setItem('sta', state.stamina);
        localStorage.setItem('coin', state.coins);
    }

    function enterYard() { alert("é€²å…¥æ±Ÿå®¶åº­é™¢ä¸­... é™½å…‰ç‘åœ¨è‰åœ°ä¸ŠçœŸç¾ï¼"); }
    function openAlbum() { alert("æ‰“é–‹ç›¸ç°¿ä¸­... æ»¿æ»¿éƒ½æ˜¯è€å¸«å€‘çš„å›æ†¶ã€‚"); }
    function openShop() { alert(state.isAdmin ? "ç®¡ç†è€…å°Šæ¦®å•†å ´é–‹å•Ÿï¼šå…¨å ´ 1 æŠ˜ï¼" : "é€²å…¥å•†å ´ä¸­..."); }

</script>
</body>
</html>
